<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#3B82F6">
    <meta name="description" content="App para gravar e resumir reuniﾃｵes com IA">
    <title>Minhas Reuniﾃｵes</title>
    
    <!-- PWA Meta Tags -->
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNDAgMjQwIj48cmVjdCB3aWR0aD0iMjQwIiBoZWlnaHQ9IjI0MCIgZmlsbD0iIzNCODJGNiIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBmb250LXNpemU9IjEyMCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iIGZpbGw9IndoaXRlIj7wn46kPC90ZXh0Pjwvc3ZnPg==">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f9fafb;
            min-height: 100vh;
            color: #1f2937;
        }
        
        .container {
            max-width: 768px;
            margin: 0 auto;
            padding: 1rem;
        }
        
        .btn {
            display: block;
            width: 100%;
            padding: 1rem;
            border: none;
            border-radius: 0.5rem;
            font-size: 1.125rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }
        
        .btn-primary {
            background: #3b82f6;
            color: white;
        }
        
        .btn-primary:hover {
            background: #2563eb;
        }
        
        .btn-danger {
            background: #ef4444;
            color: white;
        }
        
        .btn-danger:hover {
            background: #dc2626;
        }
        
        .btn-dark {
            background: #1f2937;
            color: white;
        }
        
        .btn-dark:hover {
            background: #111827;
        }
        
        .card {
            background: white;
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 1rem;
        }
        
        .card:hover {
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 1rem;
            margin-bottom: 1rem;
        }
        
        .input:focus {
            outline: none;
            border-color: #3b82f6;
        }
        
        .hidden {
            display: none !important;
        }
        
        .recording-pulse {
            animation: pulse 1.5s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .timer {
            font-size: 3rem;
            font-weight: bold;
            font-variant-numeric: tabular-nums;
            font-family: 'Courier New', monospace;
            text-align: center;
            margin: 2rem 0;
        }
        
        .tag-chip {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            background: #3b82f6;
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.875rem;
            margin: 0.25rem;
        }
        
        .tag-chip button {
            background: transparent;
            border: none;
            color: white;
            cursor: pointer;
            padding: 0.125rem;
            display: flex;
            align-items: center;
        }
        
        .tag-filter-btn {
            display: inline-block;
            padding: 0.5rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.875rem;
            border: none;
            cursor: pointer;
            margin: 0.25rem;
        }
        
        .tag-filter-btn.active {
            background: #3b82f6;
            color: white;
        }
        
        .tag-filter-btn.inactive {
            background: #e5e7eb;
            color: #374151;
        }
        
        .meeting-card {
            cursor: pointer;
        }
        
        .icon-btn {
            background: transparent;
            border: none;
            padding: 0.5rem;
            cursor: pointer;
            color: #3b82f6;
        }
        
        .icon-btn.danger {
            color: #ef4444;
        }
        
        .loader {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 3rem;
            height: 3rem;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        h1 {
            font-size: 1.875rem;
            font-weight: bold;
            margin-bottom: 1rem;
        }
        
        h2 {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }
        
        h3 {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        
        .text-gray {
            color: #6b7280;
        }
        
        .text-sm {
            font-size: 0.875rem;
        }
        
        .flex {
            display: flex;
        }
        
        .items-center {
            align-items: center;
        }
        
        .justify-between {
            justify-content: space-between;
        }
        
        .gap-2 {
            gap: 0.5rem;
        }
        
        .mb-1 { margin-bottom: 0.25rem; }
        .mb-2 { margin-bottom: 0.5rem; }
        .mb-3 { margin-bottom: 0.75rem; }
        .mb-4 { margin-bottom: 1rem; }
        
        .mt-4 { margin-top: 1rem; }
        
        .p-4 { padding: 1rem; }
        
        ul {
            list-style: none;
        }
        
        ul li {
            margin-bottom: 0.5rem;
            line-height: 1.5;
        }
        
        audio {
            width: 100%;
            margin: 1rem 0;
        }
        
        .recording-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            background: #fee2e2;
            color: #dc2626;
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            font-weight: 600;
        }
        
        .recording-dot {
            width: 0.75rem;
            height: 0.75rem;
            background: #dc2626;
            border-radius: 50%;
        }
        
        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: #9ca3af;
        }
        
        .empty-state svg {
            width: 5rem;
            height: 5rem;
            margin: 0 auto 1rem;
            opacity: 0.5;
        }
        
        .back-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            color: #3b82f6;
            background: transparent;
            border: none;
            font-size: 1rem;
            cursor: pointer;
            margin-bottom: 1rem;
        }
        
        .section-icon {
            width: 1.25rem;
            height: 1.25rem;
            margin-right: 0.5rem;
        }
        
        .section-header {
            display: flex;
            align-items: flex-start;
            margin-bottom: 0.75rem;
        }
    </style>
</head>
<body>
    
    <!-- Tela Inicial -->
    <div id="home-screen" class="container">
        <div class="flex justify-between items-center mb-4">
            <h1>Reuniﾃｵes</h1>
            <button class="icon-btn" onclick="configureApi()" title="Configurar API">
                <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                </svg>
            </button>
        </div>
        
        <div id="tag-filter" class="mb-4 hidden">
            <p class="text-sm text-gray mb-2">Filtrar por:</p>
            <div id="tag-filter-chips"></div>
        </div>
        
        <button class="btn btn-primary mb-4" onclick="showRecordingScreen()">
            + Nova Gravaﾃｧﾃ｣o
        </button>
        
        <div id="meetings-list"></div>
        
        <div id="empty-state" class="empty-state hidden">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"/>
            </svg>
            <p>Nenhuma reuniﾃ｣o gravada ainda</p>
            <p class="text-sm">Clique em "Nova Gravaﾃｧﾃ｣o" para comeﾃｧar</p>
        </div>
    </div>
    
    <!-- Tela de Gravaﾃｧﾃ｣o -->
    <div id="recording-screen" class="container hidden">
        <button class="back-btn" onclick="backToHome()">
            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
            </svg>
            Voltar
        </button>
        
        <!-- Escolha entre gravar ou upload -->
        <div id="recording-mode-selector" class="card">
            <h2 class="mb-3">Como deseja adicionar o ﾃ｡udio?</h2>
            <button class="btn btn-danger mb-2" onclick="selectRecordingMode()">
                <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="display: inline-block; vertical-align: middle; margin-right: 0.5rem;">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"/>
                </svg>
                Gravar Agora
            </button>
            <button class="btn btn-primary" onclick="selectUploadMode()">
                <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="display: inline-block; vertical-align: middle; margin-right: 0.5rem;">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                </svg>
                Fazer Upload de ﾃ「dio
            </button>
        </div>
        
        <!-- Formulﾃ｡rio de gravaﾃｧﾃ｣o/upload -->
        <div id="recording-form" class="card hidden">
            <input type="text" id="meeting-title" class="input" placeholder="Tﾃｭtulo da reuniﾃ｣o">
            
            <label class="text-sm text-gray">Participantes (opcional)</label>
            <input type="text" id="meeting-participants" class="input mb-3" placeholder="ex: Bruno, Marina, Joﾃ｣o">
            
            <label class="text-sm text-gray">Tags (opcional)</label>
            <div id="selected-tags" class="mb-2"></div>
            <input type="text" id="tag-input" class="input" placeholder="Digite uma tag e pressione Enter">
            
            <!-- Input para upload de arquivo (oculto) -->
            <input type="file" id="audio-upload" accept="audio/*" style="display: none;" onchange="handleAudioUpload(event)">
            
            <!-- Seﾃｧﾃ｣o de Upload -->
            <div id="upload-section" class="hidden">
                <button class="btn btn-primary mb-3" onclick="document.getElementById('audio-upload').click()">
                    <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="display: inline-block; vertical-align: middle; margin-right: 0.5rem;">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                    </svg>
                    Selecionar Arquivo de ﾃ「dio
                </button>
                <div id="upload-info" class="hidden" style="background: #f0fdf4; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem;">
                    <p class="text-sm" style="color: #166534; font-weight: 600;" id="upload-filename"></p>
                    <p class="text-sm" style="color: #166534;" id="upload-filesize"></p>
                </div>
                <button id="save-upload" class="btn btn-primary hidden" onclick="saveUploadedAudio()">
                    Salvar Reuniﾃ｣o
                </button>
            </div>
            
            <!-- Seﾃｧﾃ｣o de Gravaﾃｧﾃ｣o -->
            <div id="recording-section" class="hidden" style="text-align: center;">
                <div id="recording-indicator" class="hidden mb-3">
                    <span class="recording-indicator">
                        <span class="recording-dot recording-pulse"></span>
                        Gravando
                    </span>
                </div>
                <div id="timer" class="timer">00:00:00</div>
                <p id="recording-date" class="text-sm text-gray"></p>
                
                <button id="start-recording" class="btn btn-danger mt-4" onclick="startRecording()">
                    Iniciar Gravaﾃｧﾃ｣o
                </button>
                <button id="stop-recording" class="btn btn-dark mt-4 hidden" onclick="stopRecording()">
                    Parar Gravaﾃｧﾃ｣o
                </button>
            </div>
        </div>
    </div>
    
    <!-- Tela de Detalhes -->
    <div id="detail-screen" class="container hidden">
        <button class="back-btn" onclick="backToList()">
            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
            </svg>
            Voltar
        </button>
        
        <div class="flex justify-between items-center mb-3">
            <div style="flex: 1; display: flex; align-items: center; gap: 0.5rem;">
                <h2 id="detail-title"></h2>
                <button class="icon-btn" onclick="editTitle()" title="Editar tﾃｭtulo" style="padding: 0.25rem;">
                    <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                    </svg>
                </button>
            </div>
            <div class="flex gap-2">
                <button class="icon-btn" onclick="shareOnWhatsApp()">
                    <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"/>
                    </svg>
                </button>
                <button class="icon-btn danger" onclick="deleteMeetingConfirm()">
                    <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                    </svg>
                </button>
            </div>
        </div>
        
        <div class="text-sm text-gray mb-2">
            <div id="detail-date"></div>
            <div id="detail-time"></div>
            <div id="detail-duration"></div>
        </div>
        
        <div class="mb-4">
            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                <span class="text-sm text-gray">Tags:</span>
                <button class="icon-btn" onclick="editTags()" title="Editar tags" style="padding: 0.25rem;">
                    <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                    </svg>
                </button>
            </div>
            <div id="detail-tags"></div>
        </div>
        
        <div class="card">
            <h3>ﾃ「dio da Reuniﾃ｣o</h3>
            <audio id="audio-player" controls></audio>
        </div>
        
        <button id="generate-summary-btn" class="btn btn-primary mb-4" onclick="generateSummary()">
            Gerar Resumo com IA
        </button>
        
        <div id="loading-summary" class="card hidden" style="text-align: center;">
            <div class="loader"></div>
            <p class="mt-4 text-gray" id="loading-message">Transcrevendo ﾃ｡udio com Whisper...</p>
            <p class="text-sm text-gray" id="loading-detail">Depois vou gerar o resumo. Aguarde alguns minutos.</p>
        </div>
        
        <div id="summary-content" class="hidden">
            <div class="card">
                <div class="section-header">
                    <svg class="section-icon" style="color: #64748b;" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                    </svg>
                    <h3>Informaﾃｧﾃｵes da Reuniﾃ｣o</h3>
                </div>
                <div id="meeting-info" class="text-sm" style="line-height: 1.8;"></div>
            </div>
            
            <div class="card">
                <div class="section-header">
                    <svg class="section-icon" style="color: #8b5cf6;" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M9 4.804A7.968 7.968 0 005.5 4c-1.255 0-2.443.29-3.5.804v10A7.969 7.969 0 015.5 14c1.669 0 3.218.51 4.5 1.385A7.962 7.962 0 0114.5 14c1.255 0 2.443.29 3.5.804v-10A7.968 7.968 0 0014.5 4c-1.255 0-2.443.29-3.5.804V12a1 1 0 11-2 0V4.804z"/>
                    </svg>
                    <h3>Resumo Executivo</h3>
                </div>
                <div id="summary-executive" class="text-sm" style="line-height: 1.6;"></div>
            </div>
            
            <div class="card">
                <div class="section-header">
                    <svg class="section-icon" style="color: #22c55e;" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                    </svg>
                    <h3>Decisﾃｵes Tomadas</h3>
                </div>
                <div id="summary-decisions" class="text-sm"></div>
            </div>
            
            <div class="card">
                <div class="section-header">
                    <svg class="section-icon" style="color: #3b82f6;" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"/>
                        <path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"/>
                    </svg>
                    <h3>Aﾃｧﾃｵes e Tarefas</h3>
                </div>
                <div id="summary-actions" class="text-sm"></div>
            </div>
            
            <div class="card">
                <div class="section-header">
                    <svg class="section-icon" style="color: #eab308;" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                    </svg>
                    <h3>Principais Pontos Discutidos</h3>
                </div>
                <div id="summary-points" class="text-sm"></div>
            </div>
            
            <div class="card">
                <h3>Transcriﾃｧﾃ｣o Completa</h3>
                <p id="transcript-text" class="text-sm" style="white-space: pre-wrap; line-height: 1.6;"></p>
            </div>
        </div>
    </div>

    <script>
        // Estado da aplicaﾃｧﾃ｣o
        let db;
        let currentScreen = 'home';
        let isRecording = false;
        let mediaRecorder = null;
        let audioChunks = [];
        let startTime = null;
        let timerInterval = null;
        let currentMeetingId = null;
        let selectedTags = [];
        let filterTag = null;
        let uploadedAudioBlob = null;
        let wakeLock = null; // Para manter tela ativa durante gravaﾃｧﾃ｣o
        
        // ==================== INDEXEDDB ====================
        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('ReunicoesDB', 1);
                
                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    db = request.result;
                    resolve(db);
                };
                
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains('meetings')) {
                        const objectStore = db.createObjectStore('meetings', { keyPath: 'id', autoIncrement: true });
                        objectStore.createIndex('date', 'date', { unique: false });
                        objectStore.createIndex('tags', 'tags', { unique: false, multiEntry: true });
                    }
                };
            });
        }
        
        function saveMeeting(meeting) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['meetings'], 'readwrite');
                const objectStore = transaction.objectStore('meetings');
                const request = objectStore.add(meeting);
                
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }
        
        function getAllMeetings() {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['meetings'], 'readonly');
                const objectStore = transaction.objectStore('meetings');
                const request = objectStore.getAll();
                
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }
        
        function getMeeting(id) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['meetings'], 'readonly');
                const objectStore = transaction.objectStore('meetings');
                const request = objectStore.get(id);
                
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }
        
        function updateMeeting(meeting) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['meetings'], 'readwrite');
                const objectStore = transaction.objectStore('meetings');
                const request = objectStore.put(meeting);
                
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }
        
        function deleteMeeting(id) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['meetings'], 'readwrite');
                const objectStore = transaction.objectStore('meetings');
                const request = objectStore.delete(id);
                
                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }
        
        // ==================== FORMATAﾃﾃグ ====================
        function formatDate(date) {
            return new Date(date).toLocaleDateString('pt-BR', {
                day: '2-digit',
                month: 'long',
                year: 'numeric'
            });
        }
        
        function formatTime(date) {
            return new Date(date).toLocaleTimeString('pt-BR', {
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        function formatDuration(ms) {
            const seconds = Math.floor(ms / 1000);
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            
            if (hours > 0) return `${hours}h ${minutes}m ${secs}s`;
            if (minutes > 0) return `${minutes}m ${secs}s`;
            return `${secs}s`;
        }
        
        function formatTimer(ms) {
            const seconds = Math.floor(ms / 1000);
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            
            return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        }
        
        // ==================== NAVEGAﾃﾃグ ====================
        function showScreen(screen) {
            document.getElementById('home-screen').classList.add('hidden');
            document.getElementById('recording-screen').classList.add('hidden');
            document.getElementById('detail-screen').classList.add('hidden');
            
            document.getElementById(screen + '-screen').classList.remove('hidden');
            currentScreen = screen;
            
            if (screen === 'home') loadMeetings();
        }
        
        function showRecordingScreen() {
            // Resetar estado
            uploadedAudioBlob = null;
            document.getElementById('meeting-title').value = '';
            document.getElementById('meeting-participants').value = '';
            document.getElementById('audio-upload').value = '';
            document.getElementById('upload-info').classList.add('hidden');
            document.getElementById('save-upload').classList.add('hidden');
            selectedTags = [];
            renderSelectedTags();
            resetTimer();
            
            // Mostrar seletor de modo
            document.getElementById('recording-mode-selector').classList.remove('hidden');
            document.getElementById('recording-form').classList.add('hidden');
            
            showScreen('recording');
        }
        
        function selectRecordingMode() {
            // Ocultar seletor e mostrar formulﾃ｡rio de gravaﾃｧﾃ｣o
            document.getElementById('recording-mode-selector').classList.add('hidden');
            document.getElementById('recording-form').classList.remove('hidden');
            document.getElementById('recording-section').classList.remove('hidden');
            document.getElementById('upload-section').classList.add('hidden');
        }
        
        function selectUploadMode() {
            // Ocultar seletor e mostrar formulﾃ｡rio de upload
            document.getElementById('recording-mode-selector').classList.add('hidden');
            document.getElementById('recording-form').classList.remove('hidden');
            document.getElementById('upload-section').classList.remove('hidden');
            document.getElementById('recording-section').classList.add('hidden');
        }
        
        function backToHome() {
            if (isRecording) {
                if (confirm('A gravaﾃｧﾃ｣o estﾃ｡ em andamento. Deseja cancelar?')) {
                    if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                        mediaRecorder.stop();
                    }
                    isRecording = false;
                    releaseWakeLock();
                    resetRecordingScreen();
                    showScreen('home');
                }
            } else {
                resetRecordingScreen();
                showScreen('home');
            }
        }
        
        function resetRecordingScreen() {
            document.getElementById('recording-mode-selector').classList.remove('hidden');
            document.getElementById('recording-form').classList.add('hidden');
            document.getElementById('recording-section').classList.add('hidden');
            document.getElementById('upload-section').classList.add('hidden');
            document.getElementById('upload-info').classList.add('hidden');
            document.getElementById('save-upload').classList.add('hidden');
            document.getElementById('audio-upload').value = '';
            uploadedAudioBlob = null;
        }
        
        function backToList() {
            showScreen('home');
        }
        
        // ==================== UPLOAD ====================
        async function handleAudioUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Verificar se ﾃｩ um arquivo de ﾃ｡udio
            if (!file.type.startsWith('audio/')) {
                alert('Por favor, selecione um arquivo de ﾃ｡udio vﾃ｡lido.');
                return;
            }
            
            console.log('Arquivo selecionado:', file.name, 'Tamanho:', (file.size / 1024 / 1024).toFixed(2), 'MB');
            
            // Armazenar o blob do ﾃ｡udio
            uploadedAudioBlob = file;
            
            // Mostrar informaﾃｧﾃｵes do arquivo
            document.getElementById('upload-filename').textContent = `塘 ${file.name}`;
            document.getElementById('upload-filesize').textContent = `沈 Tamanho: ${(file.size / 1024 / 1024).toFixed(2)} MB`;
            document.getElementById('upload-info').classList.remove('hidden');
            document.getElementById('save-upload').classList.remove('hidden');
        }
        
        async function saveUploadedAudio() {
            if (!uploadedAudioBlob) {
                alert('Nenhum ﾃ｡udio selecionado!');
                return;
            }
            
            const title = document.getElementById('meeting-title').value || 'Reuniﾃ｣o sem tﾃｭtulo';
            
            console.log('Salvando ﾃ｡udio:', title);
            console.log('Blob:', uploadedAudioBlob);
            
            // Mostrar loading
            const saveBtn = document.getElementById('save-upload');
            saveBtn.disabled = true;
            saveBtn.textContent = 'Salvando...';
            
            try {
                // Converter blob para base64
                const audioBase64 = await blobToBase64(uploadedAudioBlob);
                
                console.log('Base64 gerado, tamanho:', audioBase64.length);
                
                // Obter duraﾃｧﾃ｣o do ﾃ｡udio (se possﾃｭvel)
                let duration = 0;
                try {
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const arrayBuffer = await uploadedAudioBlob.arrayBuffer();
                    const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
                    duration = audioBuffer.duration * 1000; // converter para ms
                    await audioContext.close();
                    console.log('Duraﾃｧﾃ｣o detectada:', duration / 1000, 'segundos');
                } catch (error) {
                    console.log('Nﾃ｣o foi possﾃｭvel detectar duraﾃｧﾃ｣o, usando estimativa');
                    // Usar tamanho do arquivo como estimativa aproximada (assumindo ~1MB por minuto)
                    duration = (uploadedAudioBlob.size / 1024 / 1024) * 60 * 1000;
                }
                
                const meeting = {
                    title: title,
                    date: new Date().toISOString(),
                    duration: duration,
                    audio: audioBase64,
                    participants: document.getElementById('meeting-participants').value.trim(),
                    tags: selectedTags,
                    summary: null,
                    transcript: null
                };
                
                console.log('Salvando no banco...');
                await saveMeeting(meeting);
                console.log('Salvo com sucesso!');
                
                // Resetar formulﾃ｡rio
                document.getElementById('meeting-title').value = '';
                document.getElementById('meeting-participants').value = '';
                document.getElementById('audio-upload').value = '';
                document.getElementById('upload-info').classList.add('hidden');
                document.getElementById('save-upload').classList.add('hidden');
                uploadedAudioBlob = null;
                selectedTags = [];
                renderSelectedTags();
                
                showScreen('home');
                alert('Reuniﾃ｣o salva com sucesso!');
                
            } catch (error) {
                console.error('Erro ao salvar:', error);
                alert('Erro ao salvar reuniﾃ｣o: ' + error.message);
                saveBtn.disabled = false;
                saveBtn.textContent = 'Salvar Reuniﾃ｣o';
            }
        }
        
        // ==================== TIMER ====================
        
        // ==================== WAKE LOCK ====================
        async function requestWakeLock() {
            try {
                if ('wakeLock' in navigator) {
                    wakeLock = await navigator.wakeLock.request('screen');
                    console.log('Wake Lock ativado - tela nﾃ｣o vai apagar durante gravaﾃｧﾃ｣o');
                    
                    wakeLock.addEventListener('release', () => {
                        console.log('Wake Lock liberado');
                    });
                } else {
                    console.log('Wake Lock nﾃ｣o suportado neste navegador');
                }
            } catch (err) {
                console.error('Erro ao ativar Wake Lock:', err);
            }
        }
        
        async function releaseWakeLock() {
            if (wakeLock) {
                try {
                    await wakeLock.release();
                    wakeLock = null;
                    console.log('Wake Lock desativado');
                } catch (err) {
                    console.error('Erro ao desativar Wake Lock:', err);
                }
            }
        }
        
        // ==================== TIMER ====================
        function startTimer() {
            startTime = Date.now();
            timerInterval = setInterval(() => {
                const elapsed = Date.now() - startTime;
                document.getElementById('timer').textContent = formatTimer(elapsed);
            }, 1000);
        }
        
        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            return Date.now() - startTime;
        }
        
        function resetTimer() {
            document.getElementById('timer').textContent = '00:00:00';
        }
        
        // ==================== GRAVAﾃﾃグ ====================
        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        sampleRate: 44100
                    }
                });
                
                // Configurar MediaRecorder com bitrate otimizado para voz
                const options = { 
                    mimeType: 'audio/webm;codecs=opus',
                    audioBitsPerSecond: 64000 // 64kbps ﾃｩ ﾃｳtimo para voz
                };
                
                // Fallback se o browser nﾃ｣o suportar opus
                if (!MediaRecorder.isTypeSupported(options.mimeType)) {
                    options.mimeType = 'audio/webm';
                }
                
                mediaRecorder = new MediaRecorder(stream, options);
                audioChunks = [];
                
                mediaRecorder.ondataavailable = (event) => {
                    audioChunks.push(event.data);
                };
                
                mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    await saveRecording(audioBlob);
                    stream.getTracks().forEach(track => track.stop());
                    releaseWakeLock();
                };
                
                mediaRecorder.start();
                isRecording = true;
                
                // Ativar Wake Lock para nﾃ｣o suspender
                await requestWakeLock();
                
                document.getElementById('start-recording').classList.add('hidden');
                document.getElementById('stop-recording').classList.remove('hidden');
                document.getElementById('recording-indicator').classList.remove('hidden');
                document.getElementById('meeting-title').disabled = true;
                document.getElementById('meeting-participants').disabled = true;
                document.getElementById('tag-input').disabled = true;
                
                startTimer();
                
                document.getElementById('recording-date').textContent = 
                    `${formatDate(Date.now())} - ${formatTime(Date.now())}`;
                
            } catch (error) {
                alert('Erro ao acessar o microfone. Verifique as permissﾃｵes no navegador.');
                console.error(error);
            }
        }
        
        function stopRecording() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                isRecording = false;
                stopTimer();
            }
        }
        
        async function saveRecording(audioBlob) {
            const title = document.getElementById('meeting-title').value || 'Reuniﾃ｣o sem tﾃｭtulo';
            const recordingDate = new Date(startTime);
            const duration = Date.now() - startTime;
            
            const reader = new FileReader();
            reader.readAsDataURL(audioBlob);
            reader.onloadend = async () => {
                const audioBase64 = reader.result;
                
                const meeting = {
                    title: title,
                    date: recordingDate.toISOString(),
                    duration: duration,
                    audio: audioBase64,
                    participants: document.getElementById('meeting-participants').value.trim(),
                    tags: selectedTags,
                    summary: null,
                    transcript: null
                };
                
                await saveMeeting(meeting);
                
                document.getElementById('meeting-title').value = '';
                document.getElementById('meeting-participants').value = '';
                document.getElementById('meeting-title').disabled = false;
                document.getElementById('meeting-participants').disabled = false;
                document.getElementById('tag-input').disabled = false;
                selectedTags = [];
                renderSelectedTags();
                resetTimer();
                
                showScreen('home');
                alert('Reuniﾃ｣o salva com sucesso!');
            };
        }
        
        // ==================== TAGS ====================
        function renderSelectedTags() {
            const container = document.getElementById('selected-tags');
            container.innerHTML = '';
            
            selectedTags.forEach(tag => {
                const chip = document.createElement('span');
                chip.className = 'tag-chip';
                chip.innerHTML = `
                    ${tag}
                    <button onclick="removeTag('${tag}')">
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
                        </svg>
                    </button>
                `;
                container.appendChild(chip);
            });
        }
        
        function removeTag(tag) {
            selectedTags = selectedTags.filter(t => t !== tag);
            renderSelectedTags();
        }
        
        async function getAllTags() {
            const meetings = await getAllMeetings();
            const tagsSet = new Set();
            meetings.forEach(meeting => {
                if (meeting.tags) {
                    meeting.tags.forEach(tag => tagsSet.add(tag));
                }
            });
            return Array.from(tagsSet);
        }
        
        async function renderTagFilter() {
            const tags = await getAllTags();
            const container = document.getElementById('tag-filter-chips');
            const filterContainer = document.getElementById('tag-filter');
            
            if (tags.length === 0) {
                filterContainer.classList.add('hidden');
                return;
            }
            
            filterContainer.classList.remove('hidden');
            container.innerHTML = '';
            
            const allBtn = document.createElement('button');
            allBtn.className = `tag-filter-btn ${!filterTag ? 'active' : 'inactive'}`;
            allBtn.textContent = 'Todas';
            allBtn.onclick = () => {
                filterTag = null;
                loadMeetings();
            };
            container.appendChild(allBtn);
            
            tags.forEach(tag => {
                const btn = document.createElement('button');
                btn.className = `tag-filter-btn ${filterTag === tag ? 'active' : 'inactive'}`;
                btn.textContent = tag;
                btn.onclick = () => {
                    filterTag = tag;
                    loadMeetings();
                };
                container.appendChild(btn);
            });
        }
        
        // ==================== LISTA ====================
        async function loadMeetings() {
            let meetings = await getAllMeetings();
            
            if (filterTag) {
                meetings = meetings.filter(m => m.tags && m.tags.includes(filterTag));
            }
            
            meetings.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            const container = document.getElementById('meetings-list');
            const emptyState = document.getElementById('empty-state');
            
            if (meetings.length === 0) {
                container.innerHTML = '';
                emptyState.classList.remove('hidden');
            } else {
                emptyState.classList.add('hidden');
                container.innerHTML = meetings.map(meeting => `
                    <div class="card meeting-card" onclick="viewMeeting(${meeting.id})">
                        <h3>${meeting.title}</h3>
                        <div class="text-sm text-gray mb-2">
                            <div>${formatDate(meeting.date)} - ${formatTime(meeting.date)}</div>
                            <div>Duraﾃｧﾃ｣o: ${formatDuration(meeting.duration)}</div>
                        </div>
                        ${meeting.tags && meeting.tags.length > 0 ? `
                            <div>
                                ${meeting.tags.map(tag => `
                                    <span style="font-size: 0.75rem; background: #dbeafe; color: #1e40af; padding: 0.25rem 0.5rem; border-radius: 0.25rem; display: inline-block; margin-right: 0.25rem;">${tag}</span>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                `).join('');
            }
            
            await renderTagFilter();
        }
        
        // ==================== DETALHES ====================
        async function viewMeeting(id) {
            currentMeetingId = id;
            const meeting = await getMeeting(id);
            
            document.getElementById('detail-title').textContent = meeting.title;
            document.getElementById('detail-date').textContent = formatDate(meeting.date);
            document.getElementById('detail-time').textContent = formatTime(meeting.date);
            document.getElementById('detail-duration').textContent = `Duraﾃｧﾃ｣o: ${formatDuration(meeting.duration)}`;
            
            const tagsContainer = document.getElementById('detail-tags');
            if (meeting.tags && meeting.tags.length > 0) {
                tagsContainer.innerHTML = meeting.tags.map(tag => `
                    <span style="background: #dbeafe; color: #1e40af; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.875rem; display: inline-block; margin-right: 0.5rem;">${tag}</span>
                `).join('');
            } else {
                tagsContainer.innerHTML = '<span class="text-sm text-gray">Nenhuma tag</span>';
            }
            
            const audioPlayer = document.getElementById('audio-player');
            audioPlayer.src = meeting.audio;
            
            if (meeting.summary) {
                document.getElementById('generate-summary-btn').classList.add('hidden');
                document.getElementById('summary-content').classList.remove('hidden');
                
                // Renderizar resumo
                renderSummary(meeting.summary, meeting.transcript || '');
            } else {
                document.getElementById('generate-summary-btn').classList.remove('hidden');
                document.getElementById('summary-content').classList.add('hidden');
            }
            
            showScreen('detail');
        }
        
        // ==================== CONFIGURAﾃﾃグ DA API ====================
        // IMPORTANTE: Pegue sua chave de API gratuita em https://console.groq.com
        const GROQ_API_KEY = localStorage.getItem('groq_api_key') || '';
        
        function checkApiKey() {
            if (!GROQ_API_KEY && !localStorage.getItem('groq_api_key')) {
                const key = prompt('Para usar a IA, vocﾃｪ precisa de uma chave de API gratuita da Groq.\n\n1. Vﾃ｡ para https://console.groq.com\n2. Crie uma conta grﾃ｡tis\n3. Vﾃ｡ em "API Keys"\n4. Crie uma nova chave\n5. Cole aqui:\n\n(A chave ficarﾃ｡ salva no seu celular)');
                
                if (key) {
                    localStorage.setItem('groq_api_key', key.trim());
                    location.reload();
                    return true;
                }
                return false;
            }
            return true;
        }
        
        function configureApi() {
            const currentKey = localStorage.getItem('groq_api_key');
            let message = 'Configure sua chave de API da Groq (100% GRﾃゝIS):\n\n';
            
            if (currentKey) {
                message += '笨 Vocﾃｪ jﾃ｡ tem uma chave configurada!\n\n';
                message += 'Para alterar, cole uma nova chave abaixo.\n';
                message += 'Para remover, deixe em branco e clique OK.\n\n';
            } else {
                message += '統 Como conseguir sua chave:\n\n';
                message += '1. Acesse: https://console.groq.com\n';
                message += '2. Crie uma conta grﾃ｡tis\n';
                message += '3. Vﾃ｡ em "API Keys"\n';
                message += '4. Clique em "Create API Key"\n';
                message += '5. Copie a chave\n';
                message += '6. Cole aqui:\n\n';
            }
            
            const key = prompt(message, currentKey || '');
            
            if (key === null) return; // Cancelou
            
            if (key.trim() === '') {
                localStorage.removeItem('groq_api_key');
                alert('Chave de API removida!');
            } else {
                localStorage.setItem('groq_api_key', key.trim());
                alert('Chave de API salva com sucesso! 笨');
            }
        }
        
        // ==================== IA ====================
        
        // Dividir ﾃ｡udio em chunks temporais (10 minutos cada, 16kHz) usando Web Audio API
        async function splitAudioByDuration(audioBase64, chunkMinutes = 10) {
            try {
                console.log('=== DIVIDINDO ﾃゞDIO POR TEMPO ===');
                console.log('Duraﾃｧﾃ｣o de cada chunk:', chunkMinutes, 'minutos');
                
                // Converter base64 para blob
                const response = await fetch(audioBase64);
                const blob = await response.blob();
                
                console.log('Tamanho do arquivo original:', (blob.size / 1024 / 1024).toFixed(2), 'MB');
                
                // Se arquivo for menor que 8MB, nﾃ｣o precisa dividir
                if (blob.size < 8 * 1024 * 1024) {
                    console.log('Arquivo menor que 8MB, nﾃ｣o precisa dividir');
                    return [audioBase64];
                }
                
                // Criar contexto de ﾃ｡udio
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const arrayBuffer = await blob.arrayBuffer();
                const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
                
                const totalDuration = audioBuffer.duration; // segundos
                const chunkDuration = chunkMinutes * 60; // converter para segundos
                
                console.log('Duraﾃｧﾃ｣o total:', (totalDuration / 60).toFixed(1), 'minutos');
                console.log('Duraﾃｧﾃ｣o por chunk:', chunkMinutes, 'minutos');
                
                // Calcular nﾃｺmero de chunks
                const numberOfChunks = Math.ceil(totalDuration / chunkDuration);
                console.log('Nﾃｺmero de chunks:', numberOfChunks);
                
                if (numberOfChunks === 1) {
                    console.log('Apenas 1 chunk, nﾃ｣o precisa dividir');
                    await audioContext.close();
                    return [audioBase64];
                }
                
                const chunks = [];
                
                // Criar cada chunk com sample rate reduzido
                for (let i = 0; i < numberOfChunks; i++) {
                    const startTime = i * chunkDuration;
                    const endTime = Math.min((i + 1) * chunkDuration, totalDuration);
                    
                    console.log(`Criando chunk ${i + 1}/${numberOfChunks}: ${(startTime/60).toFixed(1)}min - ${(endTime/60).toFixed(1)}min`);
                    
                    // Criar buffer para este chunk COM SAMPLE RATE REDUZIDO
                    const startSample = Math.floor(startTime * audioBuffer.sampleRate);
                    const endSample = Math.floor(endTime * audioBuffer.sampleRate);
                    const originalLength = endSample - startSample;
                    
                    // Sample rate reduzido para 16kHz (suficiente para voz)
                    const targetSampleRate = 16000;
                    const resampleRatio = targetSampleRate / audioBuffer.sampleRate;
                    const resampledLength = Math.floor(originalLength * resampleRatio);
                    
                    const chunkBuffer = audioContext.createBuffer(
                        1, // Mono (reduz pela metade se original for stereo)
                        resampledLength,
                        targetSampleRate
                    );
                    
                    // Resample e copiar samples (com downsampling simples)
                    const sourceChannel = audioBuffer.getChannelData(0); // Pega primeiro canal
                    const chunkData = chunkBuffer.getChannelData(0);
                    
                    for (let j = 0; j < resampledLength; j++) {
                        const sourceIndex = Math.floor(j / resampleRatio) + startSample;
                        if (sourceIndex < endSample && sourceIndex < sourceChannel.length) {
                            chunkData[j] = sourceChannel[sourceIndex];
                        }
                    }
                    
                    // Se original for stereo, fazer mix para mono
                    if (audioBuffer.numberOfChannels > 1) {
                        const sourceChannel2 = audioBuffer.getChannelData(1);
                        for (let j = 0; j < resampledLength; j++) {
                            const sourceIndex = Math.floor(j / resampleRatio) + startSample;
                            if (sourceIndex < endSample && sourceIndex < sourceChannel2.length) {
                                chunkData[j] = (chunkData[j] + sourceChannel2[sourceIndex]) / 2;
                            }
                        }
                    }
                    
                    // Converter para WAV blob
                    const chunkWav = audioBufferToWav(chunkBuffer);
                    const chunkBlob = new Blob([chunkWav], { type: 'audio/wav' });
                    
                    console.log(`Chunk ${i + 1} tamanho:`, (chunkBlob.size / 1024 / 1024).toFixed(2), 'MB');
                    
                    // Converter para base64
                    const chunkBase64 = await new Promise((resolve) => {
                        const reader = new FileReader();
                        reader.onloadend = () => resolve(reader.result);
                        reader.readAsDataURL(chunkBlob);
                    });
                    
                    chunks.push(chunkBase64);
                }
                
                await audioContext.close();
                
                console.log('=== DIVISﾃグ COMPLETA ===');
                console.log('Total de chunks:', chunks.length);
                
                return chunks;
                
            } catch (error) {
                console.error('Erro ao dividir ﾃ｡udio:', error);
                // Em caso de erro, retorna ﾃ｡udio original
                return [audioBase64];
            }
        }
        
        // Converter AudioBuffer para WAV
        function audioBufferToWav(audioBuffer) {
            const numChannels = audioBuffer.numberOfChannels;
            const sampleRate = audioBuffer.sampleRate;
            const format = 1; // PCM
            const bitDepth = 16;
            
            const bytesPerSample = bitDepth / 8;
            const blockAlign = numChannels * bytesPerSample;
            
            const samples = [];
            for (let i = 0; i < audioBuffer.length; i++) {
                for (let channel = 0; channel < numChannels; channel++) {
                    const sample = audioBuffer.getChannelData(channel)[i];
                    // Converter para 16-bit PCM
                    const int16 = Math.max(-1, Math.min(1, sample)) * 0x7FFF;
                    samples.push(int16);
                }
            }
            
            const dataLength = samples.length * bytesPerSample;
            const buffer = new ArrayBuffer(44 + dataLength);
            const view = new DataView(buffer);
            
            // WAV Header
            const writeString = (offset, string) => {
                for (let i = 0; i < string.length; i++) {
                    view.setUint8(offset + i, string.charCodeAt(i));
                }
            };
            
            writeString(0, 'RIFF');
            view.setUint32(4, 36 + dataLength, true);
            writeString(8, 'WAVE');
            writeString(12, 'fmt ');
            view.setUint32(16, 16, true); // fmt chunk size
            view.setUint16(20, format, true);
            view.setUint16(22, numChannels, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * blockAlign, true);
            view.setUint16(32, blockAlign, true);
            view.setUint16(34, bitDepth, true);
            writeString(36, 'data');
            view.setUint32(40, dataLength, true);
            
            // Write PCM samples
            let offset = 44;
            for (let i = 0; i < samples.length; i++) {
                view.setInt16(offset, samples[i], true);
                offset += 2;
            }
            
            return buffer;
        }
        
        // Funﾃｧﾃ｣o para renderizar resumo (suporta formato novo e antigo)
        function renderSummary(summary, transcript = '') {
            // Informaﾃｧﾃｵes da Reuniﾃ｣o
            if (summary.meeting_info) {
                let infoHTML = `
                    <p style="margin-bottom: 0.5rem;"><strong>Data:</strong> ${summary.meeting_info.date || 'Nﾃ｣o informada'}</p>
                    <p style="margin-bottom: 0.5rem;"><strong>Duraﾃｧﾃ｣o:</strong> ${summary.meeting_info.duration_minutes || 0} minutos</p>
                    <p style="margin-bottom: 0.5rem;"><strong>Participantes:</strong> ${summary.meeting_info.participants || 'Nﾃ｣o informados'}</p>
                    <p style="margin-bottom: 0.5rem;"><strong>Tipo:</strong> ${summary.meeting_info.meeting_type || 'Nﾃ｣o identificado'}</p>
                `;
                if (summary.meeting_info.context) {
                    infoHTML += `<p style="margin-bottom: 0.5rem;"><strong>Contexto:</strong> ${summary.meeting_info.context}</p>`;
                }
                document.getElementById('meeting-info').innerHTML = infoHTML;
            } else {
                document.getElementById('meeting-info').innerHTML = '<p style="opacity: 0.7; font-style: italic;">Informaﾃｧﾃｵes nﾃ｣o disponﾃｭveis</p>';
            }
            
            // Resumo Executivo
            const execDiv = document.getElementById('summary-executive');
            if (typeof summary.executive_summary === 'object' && summary.executive_summary !== null) {
                // Formato novo estruturado
                let execHTML = '';
                if (summary.executive_summary.context_and_purpose) {
                    execHTML += `<p style="margin-bottom: 1rem;"><strong>Contexto e Propﾃｳsito:</strong><br>${summary.executive_summary.context_and_purpose}</p>`;
                }
                if (summary.executive_summary.conversation_development) {
                    execHTML += `<p style="margin-bottom: 1rem;"><strong>Desenvolvimento:</strong><br>${summary.executive_summary.conversation_development}</p>`;
                }
                if (summary.executive_summary.emotional_dynamics) {
                    execHTML += `<p style="margin-bottom: 1rem;"><strong>Dinﾃ｢mica Emocional:</strong><br>${summary.executive_summary.emotional_dynamics}</p>`;
                }
                if (summary.executive_summary.key_revelations) {
                    execHTML += `<p style="margin-bottom: 1rem;"><strong>Principais Revelaﾃｧﾃｵes:</strong><br>${summary.executive_summary.key_revelations}</p>`;
                }
                if (summary.executive_summary.conclusion) {
                    execHTML += `<p style="margin-bottom: 0;"><strong>Conclusﾃ｣o:</strong><br>${summary.executive_summary.conclusion}</p>`;
                }
                execDiv.innerHTML = execHTML;
            } else {
                // Formato antigo ou string simples
                execDiv.textContent = summary.executive_summary || summary.general || 'Resumo nﾃ｣o disponﾃｭvel';
            }
            
            // Decisﾃｵes
            document.getElementById('summary-decisions').innerHTML = summary.decisions
                .map(d => {
                    if (d.decision && d.decision.includes("Nenhuma decisﾃ｣o")) {
                        return `<p style="opacity: 0.7; font-style: italic;">窶｢ ${d.decision}</p>`;
                    }
                    let html = `<div style="margin-bottom: 1rem;">
                        <p style="font-weight: 600; margin-bottom: 0.25rem;">窶｢ ${d.decision || d}</p>`;
                    if (d.context) html += `<p style="opacity: 0.7; margin-left: 1rem; font-size: 0.875rem;">Contexto: ${d.context}</p>`;
                    if (d.impact) html += `<p style="opacity: 0.7; margin-left: 1rem; font-size: 0.875rem;">Impacto: ${d.impact}</p>`;
                    html += `</div>`;
                    return html;
                }).join('');
            
            // Aﾃｧﾃｵes
            document.getElementById('summary-actions').innerHTML = summary.actions
                .map(a => {
                    if (a.action && a.action.includes("Nenhuma aﾃｧﾃ｣o")) {
                        return `<p style="opacity: 0.7; font-style: italic;">窶｢ ${a.action}</p>`;
                    }
                    return `<p style="margin-bottom: 0.5rem;">窶｢ ${a.action || a}${a.responsible ? ` - <strong>Responsﾃ｡vel:</strong> ${a.responsible}` : ''}</p>`;
                }).join('');
            
            // Principais Pontos
            let pointsHTML = '';
            if (summary.key_points && typeof summary.key_points === 'object') {
                for (const [category, points] of Object.entries(summary.key_points)) {
                    pointsHTML += `<div style="margin-bottom: 1rem;">
                        <p style="font-weight: 600; color: #eab308; margin-bottom: 0.5rem;">${category}:</p>
                        <ul style="margin-left: 1rem;">
                            ${(Array.isArray(points) ? points : [points]).map(p => `<li style="margin-bottom: 0.25rem;">窶｢ ${p}</li>`).join('')}
                        </ul>
                    </div>`;
                }
            } else if (Array.isArray(summary.points)) {
                // Formato antigo
                pointsHTML = '<ul>' + summary.points.map(p => `<li style="margin-bottom: 0.25rem;">窶｢ ${p}</li>`).join('') + '</ul>';
            }
            document.getElementById('summary-points').innerHTML = pointsHTML || '<p style="opacity: 0.7;">Nenhum ponto registrado</p>';
            
            // Transcriﾃｧﾃ｣o - SEMPRE usar a passada como parﾃ｢metro (completa), nﾃ｣o a do summary
            document.getElementById('transcript-text').textContent = transcript || summary.full_transcript || 'Transcriﾃｧﾃ｣o nﾃ｣o disponﾃｭvel';
        }
        
        async function generateSummary() {
            const meeting = await getMeeting(currentMeetingId);
            
            // Verificar API key
            const apiKey = localStorage.getItem('groq_api_key');
            if (!apiKey) {
                if (!checkApiKey()) {
                    alert('Vocﾃｪ precisa configurar a chave de API da Groq para usar a IA.\n\nEla ﾃｩ 100% grﾃ｡tis! Veja as instruﾃｧﾃｵes.');
                    return;
                }
            }
            
            document.getElementById('generate-summary-btn').classList.add('hidden');
            document.getElementById('loading-summary').classList.remove('hidden');
            document.getElementById('loading-message').textContent = 'Preparando ﾃ｡udio...';
            document.getElementById('loading-detail').textContent = 'Analisando duraﾃｧﾃ｣o e dividindo se necessﾃ｡rio.';
            
            try {
                console.log('=== INICIANDO GERAﾃﾃグ DE RESUMO ===');
                console.log('ID da reuniﾃ｣o:', currentMeetingId);
                
                // Dividir ﾃ｡udio em chunks de 10 minutos (16kHz para reduzir tamanho)
                console.log('Passo 1: Dividindo ﾃ｡udio...');
                const audioChunks = await splitAudioByDuration(meeting.audio, 10);
                console.log('ﾃ「dio dividido em', audioChunks.length, 'chunks');
                
                // Transcrever cada chunk
                console.log('Passo 2: Transcrevendo chunks...');
                let fullTranscript = '';
                
                for (let i = 0; i < audioChunks.length; i++) {
                    document.getElementById('loading-message').textContent = 
                        `Transcrevendo parte ${i + 1} de ${audioChunks.length}...`;
                    document.getElementById('loading-detail').textContent = 
                        'Isso pode levar alguns minutos. Aguarde.';
                    
                    console.log(`Transcrevendo chunk ${i + 1}/${audioChunks.length}...`);
                    
                    try {
                        const chunkTranscript = await transcribeWithWhisper(audioChunks[i], apiKey);
                        
                        // Adicionar ao transcript completo
                        if (fullTranscript) fullTranscript += '\n\n';
                        fullTranscript += chunkTranscript;
                        
                        console.log(`Chunk ${i + 1} transcrito! Tamanho:`, chunkTranscript.length, 'caracteres');
                    } catch (error) {
                        console.error(`Erro ao transcrever chunk ${i + 1}:`, error);
                        
                        // Se for o primeiro chunk e falhou, propagar erro
                        if (i === 0) {
                            throw error;
                        }
                        
                        // Senﾃ｣o, adicionar placeholder e continuar
                        if (fullTranscript) fullTranscript += '\n\n';
                        fullTranscript += `[Parte ${i + 1} nﾃ｣o pﾃｴde ser transcrita]`;
                    }
                }
                
                console.log('Transcriﾃｧﾃ｣o completa! Tamanho total:', fullTranscript.length, 'caracteres');
                
                // Gerar resumo com a transcriﾃｧﾃ｣o
                document.getElementById('loading-message').textContent = 'Gerando resumo com IA...';
                document.getElementById('loading-detail').textContent = 'Analisando a transcriﾃｧﾃ｣o e criando resumo estruturado.';
                
                console.log('Passo 3: Gerando resumo...');
                const summary = await generateSummaryFromTranscript(
                    fullTranscript, 
                    meeting.participants || '', 
                    meeting.title || '',
                    meeting.date || '',
                    meeting.duration || 0
                );
                console.log('Resumo gerado:', summary);
                
                meeting.transcript = fullTranscript;
                meeting.summary = summary;
                await updateMeeting(meeting);
                console.log('Reuniﾃ｣o atualizada no banco!');
                
                document.getElementById('loading-summary').classList.add('hidden');
                document.getElementById('summary-content').classList.remove('hidden');
                
                // Renderizar resumo
                renderSummary(summary, fullTranscript);
                
                console.log('=== RESUMO CONCLUﾃ好O COM SUCESSO ===');
                
            } catch (error) {
                console.error('=== ERRO AO GERAR RESUMO ===');
                console.error('Tipo de erro:', error.name);
                console.error('Mensagem:', error.message);
                console.error('Stack:', error.stack);
                
                let errorMsg = 'Erro ao gerar resumo.';
                if (error.message.includes('401') || error.message.includes('403')) {
                    errorMsg = 'Chave de API invﾃ｡lida. Clique no ﾃｭcone 笞呻ｸ para configurar novamente.';
                    localStorage.removeItem('groq_api_key');
                } else if (error.message.includes('413')) {
                    errorMsg = 'Chunk ainda muito grande.\n\nPor favor, reporte este erro.';
                } else if (error.message.includes('400') || error.message.includes('invalid')) {
                    errorMsg = 'Formato de ﾃ｡udio incompatﾃｭvel.\n\nTente gravar em formato diferente.';
                }
                
                alert(errorMsg + '\n\nDetalhes tﾃｩcnicos: ' + error.message);
                document.getElementById('loading-summary').classList.add('hidden');
                document.getElementById('generate-summary-btn').classList.remove('hidden');
            }
        }
        
        // Funﾃｧﾃ｣o auxiliar para converter Blob em Base64
        function blobToBase64(blob) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(blob);
            });
        }
        
        async function transcribeWithWhisper(audioBase64, apiKey) {
            try {
                // Converter base64 para blob
                const response = await fetch(audioBase64);
                const blob = await response.blob();
                
                // Criar arquivo de ﾃ｡udio
                const audioFile = new File([blob], 'audio.wav', { type: blob.type });
                
                console.log('Arquivo de ﾃ｡udio:', audioFile.name, 'Tamanho:', (audioFile.size / 1024 / 1024).toFixed(2), 'MB');
                
                // Criar FormData
                const formData = new FormData();
                formData.append('file', audioFile);
                formData.append('model', 'whisper-large-v3');
                formData.append('language', 'pt');
                formData.append('response_format', 'text');
                
                // Fazer requisiﾃｧﾃ｣o para Whisper API da Groq
                const whisperResponse = await fetch('https://api.groq.com/openai/v1/audio/transcriptions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: formData
                });
                
                if (!whisperResponse.ok) {
                    const errorData = await whisperResponse.text();
                    console.error('Erro Whisper:', errorData);
                    throw new Error(`Whisper API error ${whisperResponse.status}: ${errorData}`);
                }
                
                const transcript = await whisperResponse.text();
                
                if (!transcript || transcript.trim().length < 10) {
                    throw new Error('Transcriﾃｧﾃ｣o vazia ou muito curta. Verifique se o ﾃ｡udio tem fala clara.');
                }
                
                return transcript.trim();
                
            } catch (error) {
                console.error('Erro na transcriﾃｧﾃ｣o:', error);
                throw new Error(`Falha ao transcrever ﾃ｡udio: ${error.message}`);
            }
        }
        
        async function generateSummaryFromTranscript(transcript, participants = '', title = '', date = '', duration = 0) {
            const apiKey = localStorage.getItem('groq_api_key');
            
            console.log('===== INICIANDO GERAﾃﾃグ DE RESUMO =====');
            console.log('API Key existe?', !!apiKey);
            console.log('API Key (primeiros 10 chars):', apiKey ? apiKey.substring(0, 10) + '...' : 'NENHUMA');
            console.log('Tamanho da transcriﾃｧﾃ｣o:', transcript.length);
            console.log('Participantes:', participants || 'nﾃ｣o informado');
            console.log('Tﾃｭtulo:', title || 'nﾃ｣o informado');
            console.log('Duraﾃｧﾃ｣o:', duration, 'ms');
            
            if (!apiKey || apiKey.length < 20) {
                alert('API Key invﾃ｡lida ou nﾃ｣o configurada!\n\nClique no ﾃｭcone 笞呻ｸ para configurar.');
                throw new Error('API Key nﾃ｣o configurada');
            }
            
            // Truncar transcriﾃｧﾃ｣o para caber na requisiﾃｧﾃ｣o da API
            // Limite: ~12000 caracteres para nﾃ｣o exceder tamanho mﾃ｡ximo de request
            let transcriptToSend = transcript;
            let truncatedNote = '';
            
            if (transcript.length > 12000) {
                transcriptToSend = transcript.substring(0, 12000);
                const percentageCovered = Math.round((12000 / transcript.length) * 100);
                truncatedNote = `\n\n[NOTA: Esta transcriﾃｧﾃ｣o foi truncada para ${percentageCovered}% do total devido a limitaﾃｧﾃｵes da API. O resumo ﾃｩ baseado nos primeiros ~35-40 minutos da reuniﾃ｣o. A transcriﾃｧﾃ｣o COMPLETA estﾃ｡ preservada no documento.]`;
                console.log('Transcriﾃｧﾃ｣o truncada para:', transcriptToSend.length, 'caracteres');
                console.log('Percentual:', percentageCovered, '%');
            } else {
                console.log('Transcriﾃｧﾃ｣o completa enviada:', transcript.length, 'caracteres');
            }
            
            const durationMinutes = Math.round(duration / 60000);
            const dateFormatted = date ? new Date(date).toLocaleString('pt-BR', {
                day: '2-digit',
                month: '2-digit', 
                year: 'numeric'
            }) : '';
            
            const systemMsg = `Vocﾃｪ ﾃｩ um assistente especializado em criar resumos executivos EXTREMAMENTE DETALHADOS de reuniﾃｵes em portuguﾃｪs. 
Vocﾃｪ deve capturar TODOS os detalhes, exemplos especﾃｭficos, nomes, situaﾃｧﾃｵes, citaﾃｧﾃｵes, e criar documentaﾃｧﾃ｣o profissional completa.
Seu objetivo ﾃｩ criar um documento tﾃ｣o detalhado que alguﾃｩm que nﾃ｣o participou da reuniﾃ｣o entenda COMPLETAMENTE tudo que aconteceu.`;

            const userMsg = `Crie um resumo COMPLETO e EXTREMAMENTE DETALHADO da seguinte reuniﾃ｣o:

DADOS DA REUNIﾃグ:
- Tﾃｭtulo: ${title || 'Nﾃ｣o informado'}
- Data: ${dateFormatted || 'Nﾃ｣o informada'}
- Duraﾃｧﾃ｣o: ${durationMinutes} minutos
- Participantes: ${participants || 'Nﾃ｣o informados'}

TRANSCRIﾃﾃグ:
${transcriptToSend}${truncatedNote}

Retorne um JSON com esta estrutura EXATA:
{
  "meeting_info": {
    "date": "${dateFormatted}",
    "duration_minutes": ${durationMinutes},
    "participants": "${participants || 'Nﾃ｣o informados'}",
    "meeting_type": "[Identifique o tipo: 1:1 / Planejamento / Cliente / Operacional / Feedback / Desabafo / etc]",
    "context": "[Breve contexto sobre o que motivou esta reuniﾃ｣o, se identificﾃ｡vel]"
  },
  
  "executive_summary": {
    "context_and_purpose": "[Parﾃ｡grafo de 80-120 palavras] Quem sﾃ｣o as pessoas envolvidas (cargos, relaﾃｧﾃ｣o entre elas). O que motivou esta conversa. Qual era a expectativa ou objetivo.",
    
    "conversation_development": "[Parﾃ｡grafo de 100-150 palavras] Descreva em detalhes os principais temas abordados. Inclua EXEMPLOS ESPECﾃ孝ICOS mencionados na conversa (nomes, situaﾃｧﾃｵes, locais). Mencione CITAﾃﾃ髭S ou frases-chave que foram ditas. Descreva a evoluﾃｧﾃ｣o da conversa (como comeﾃｧou, como se desenvolveu, como terminou).",
    
    "emotional_dynamics": "[Parﾃ｡grafo de 50-80 palavras] Qual era o estado emocional dos participantes. Como o tom da conversa mudou ao longo do tempo. Momentos de tensﾃ｣o, alﾃｭvio, emoﾃｧﾃ｣o.",
    
    "key_revelations": "[Parﾃ｡grafo de 50-80 palavras] O que foi revelado de importante. Quais foram os insights principais. Padrﾃｵes ou temas recorrentes identificados.",
    
    "conclusion": "[Parﾃ｡grafo de 40-60 palavras] Como a conversa foi encerrada. Qual o sentimento final. O que ficou pendente ou precisa ser endereﾃｧado."
  },
  
  "decisions": [
    {
      "decision": "[Decisﾃ｣o clara e especﾃｭfica]",
      "context": "[Por que esta decisﾃ｣o foi tomada]",
      "impact": "[Quem ou o que esta decisﾃ｣o afeta]"
    }
  ],
  
  "actions": [
    {
      "action": "[Aﾃｧﾃ｣o clara e acionﾃ｡vel]",
      "responsible": "[Nome do responsﾃ｡vel]"
    }
  ],
  
  "key_points": {
    "Desafios e Dificuldades": [
      "[Descreva situaﾃｧﾃｵes ESPECﾃ孝ICAS mencionadas com NOMES e DETALHES]",
      "[Outro desafio especﾃｭfico com detalhes]"
    ],
    "Comportamentos e Atitudes": [
      "[Descreva atitudes especﾃｭficas mencionadas com exemplos concretos]",
      "[Outro comportamento]"
    ],
    "Relacionamentos e Dinﾃ｢micas": [
      "[Relacionamentos mencionados com nomes e situaﾃｧﾃｵes]",
      "[Outras dinﾃ｢micas]"
    ],
    "Valores e Princﾃｭpios": [
      "[Valores expressos pela pessoa]"
    ],
    "Sentimentos e Emoﾃｧﾃｵes": [
      "[Estados emocionais especﾃｭficos expressos]"
    ],
    "Aspiraﾃｧﾃｵes e Objetivos": [
      "[O que a pessoa deseja alcanﾃｧar]"
    ]
  }
}

INSTRUﾃﾃ髭S ABSOLUTAMENTE CRﾃ控ICAS:

1. RESUMO EXECUTIVO (250-400 palavras TOTAIS):
   - Divida em 5 parﾃ｡grafos conforme estrutura acima
   - Seja EXTREMAMENTE DETALHADO e ESPECﾃ孝ICO
   - Mencione NOMES, SITUAﾃﾃ髭S, LOCAIS, EXEMPLOS citados
   - Inclua CITAﾃﾃ髭S literais importantes
   - Nﾃグ seja genﾃｩrico - seja descritivo e rico em detalhes
   - Use exemplos concretos: "Mari relatou que ao tentar limpar a mesa com ﾃ｡lcool em gel no primeiro dia, foi repreendida por Barbosa"

2. PRINCIPAIS PONTOS (6-12 bullets bem desenvolvidos):
   - Use EXEMPLOS ESPECﾃ孝ICOS da conversa
   - Cite NOMES de pessoas, locais, situaﾃｧﾃｵes
   - Nﾃ｣o seja vago - seja concreto
   - "Mari mencionou que viu Caio esquecer comida no ralo e escolheu apenas higienizar sem repreendﾃｪ-lo"

3. DECISﾃ髭S E Aﾃﾃ髭S:
   - Se nﾃ｣o houve decisﾃｵes formais: [{"decision": "Nenhuma decisﾃ｣o formal registrada - esta foi uma conversa de escuta e acolhimento", "context": "", "impact": ""}]
   - Se nﾃ｣o houve aﾃｧﾃｵes explﾃｭcitas: [{"action": "Nenhuma aﾃｧﾃ｣o explﾃｭcita definida - recomenda-se acompanhamento posterior", "responsible": ""}]
   - Se houve aﾃｧﾃｵes IMPLﾃ垢ITAS, liste-as

4. QUALIDADE ESPERADA:
   - Leitor que nﾃ｣o participou deve entender COMPLETAMENTE apenas lendo o resumo executivo
   - Use detalhes, nomes, exemplos, citaﾃｧﾃｵes - seja RICO e ESPECﾃ孝ICO
   - Mantenha foco na QUALIDADE do resumo, nﾃ｣o no tamanho da resposta

IMPORTANTE: Nﾃグ retorne a transcriﾃｧﾃ｣o no JSON. Apenas resumo, decisﾃｵes, aﾃｧﾃｵes e pontos principais.

Retorne APENAS o JSON, sem markdown ou texto adicional.`;

            try {
                console.log('Fazendo chamada para API Groq...');
                
                const requestBody = {
                    model: "llama-3.3-70b-versatile",
                    messages: [
                        { role: "system", content: systemMsg },
                        { role: "user", content: userMsg }
                    ],
                    temperature: 0.3,
                    max_tokens: 8192  // Aumentado para resumos MUITO detalhados e transcriﾃｧﾃｵes completas
                };
                
                console.log('Modelo:', requestBody.model);
                console.log('Max tokens:', requestBody.max_tokens);
                
                const response = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${apiKey}`
                    },
                    body: JSON.stringify(requestBody)
                });
                
                console.log('Status da resposta:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('ERRO da API:');
                    console.error('Status:', response.status);
                    console.error('Texto completo:', errorText);
                    
                    let errorMsg = `API retornou status ${response.status}`;
                    
                    if (response.status === 400) {
                        errorMsg = 'Requisiﾃｧﾃ｣o invﾃ｡lida (400). Possﾃｭveis causas:\n';
                        errorMsg += '- API Key pode estar incorreta\n';
                        errorMsg += '- Modelo pode nﾃ｣o existir\n';
                        errorMsg += '- Formato da requisiﾃｧﾃ｣o invﾃ｡lido\n\n';
                        errorMsg += 'Detalhes: ' + errorText.substring(0, 200);
                    } else if (response.status === 401) {
                        errorMsg = 'API Key invﾃ｡lida (401). Reconfigure no ﾃｭcone 笞呻ｸ';
                    } else if (response.status === 429) {
                        errorMsg = 'Limite de requisiﾃｧﾃｵes atingido (429). Aguarde alguns minutos.';
                    }
                    
                    throw new Error(errorMsg);
                }
                
                const data = await response.json();
                console.log('Resposta recebida:', data);
                
                if (!data.choices || !data.choices[0]) {
                    console.error('Resposta sem choices');
                    throw new Error('Resposta invﾃ｡lida da API');
                }
                
                let responseText = data.choices[0].message.content;
                console.log('Conteﾃｺdo da resposta:', responseText);
                
                // Limpar markdown
                responseText = responseText.replace(/```json\n?/g, "").replace(/```\n?/g, "").trim();
                
                // Limpar caracteres de controle invﾃ｡lidos em JSON
                // (mantﾃｩm apenas \n, \t, \r que sﾃ｣o vﾃ｡lidos quando escapados)
                responseText = responseText.replace(/[\x00-\x08\x0B-\x0C\x0E-\x1F]/g, '');
                
                // Verificar se JSON estﾃ｡ truncado (termina sem fechar chaves)
                if (!responseText.endsWith('}')) {
                    console.warn('笞ｸ Resposta parece truncada, tentando completar...');
                    // Contar chaves abertas vs fechadas
                    const openBraces = (responseText.match(/\{/g) || []).length;
                    const closeBraces = (responseText.match(/\}/g) || []).length;
                    const missing = openBraces - closeBraces;
                    
                    if (missing > 0) {
                        console.warn(`Faltam ${missing} chaves de fechamento`);
                        // Adicionar chaves faltantes
                        responseText += '\n' + '}'.repeat(missing);
                    }
                }
                
                console.log('Texto limpo:', responseText.substring(0, 500) + '...');
                
                // Parse do JSON
                let summary;
                try {
                    summary = JSON.parse(responseText);
                    console.log('笨 JSON parseado com sucesso!', summary);
                } catch (e) {
                    console.error('笶 ERRO ao parsear JSON:', e);
                    console.error('Primeiros 1000 chars:', responseText.substring(0, 1000));
                    console.error('ﾃ嗟timos 500 chars:', responseText.substring(responseText.length - 500));
                    throw new Error('IA nﾃ｣o retornou JSON vﾃ｡lido: ' + e.message);
                }
                
                // Validar campos do novo formato
                if (!summary.meeting_info) {
                    summary.meeting_info = {
                        date: dateFormatted || '',
                        duration_minutes: durationMinutes,
                        participants: participants || 'Nﾃ｣o informados',
                        meeting_type: 'Nﾃ｣o identificado',
                        context: ''
                    };
                }
                
                // executive_summary pode ser string (formato antigo) ou objeto (formato novo)
                if (typeof summary.executive_summary === 'object' && summary.executive_summary !== null) {
                    // Formato novo - jﾃ｡ estruturado
                } else if (typeof summary.executive_summary === 'string') {
                    // Formato antigo ou string simples - manter como estﾃ｡
                } else {
                    summary.executive_summary = "Resumo nﾃ｣o disponﾃｭvel";
                }
                
                // SEMPRE usar transcriﾃｧﾃ｣o completa original, nﾃ｣o a retornada pela IA
                // (que pode estar truncada ou modificada)
                summary.full_transcript = transcript;
                if (!Array.isArray(summary.decisions) || summary.decisions.length === 0) {
                    summary.decisions = [{decision: "Nenhuma decisﾃ｣o formal registrada nesta reuniﾃ｣o", context: "", impact: ""}];
                }
                if (!Array.isArray(summary.actions) || summary.actions.length === 0) {
                    summary.actions = [{action: "Nenhuma aﾃｧﾃ｣o especﾃｭfica definida nesta reuniﾃ｣o", responsible: ""}];
                }
                if (!summary.key_points || typeof summary.key_points !== 'object') {
                    summary.key_points = {"Geral": ["Veja a transcriﾃｧﾃ｣o completa"]};
                }
                
                console.log('===== RESUMO GERADO COM SUCESSO =====');
                console.log(summary);
                return summary;
                
            } catch (error) {
                console.error('===== ERRO AO GERAR RESUMO =====');
                console.error('Tipo:', error.name);
                console.error('Mensagem:', error.message);
                console.error('Stack:', error.stack);
                
                alert('ERRO ao gerar resumo:\n\n' + error.message + '\n\nAbra o Console (F12) para ver detalhes.');
                
                return {
                    meeting_info: {
                        date: dateFormatted || '',
                        duration_minutes: durationMinutes,
                        participants: participants || 'Nﾃ｣o informados',
                        meeting_type: 'Erro',
                        context: error.message
                    },
                    executive_summary: "ERRO: " + error.message,
                    decisions: [{decision: "Erro ao processar", context: "", impact: ""}],
                    actions: [{action: "Abra o console (F12) para ver detalhes", responsible: ""}],
                    key_points: {"Erro": ["Tente novamente"]},
                    full_transcript: transcript
                };
            }
        }
        
        // ==================== WHATSAPP ====================
        async function shareOnWhatsApp() {
            const meeting = await getMeeting(currentMeetingId);
            
            let message = `統 *${meeting.title}*\n\n`;
            message += `套 ${formatDate(meeting.date)}\n`;
            message += `葡 ${formatTime(meeting.date)}\n`;
            message += `竢ｱｸ Duraﾃｧﾃ｣o: ${formatDuration(meeting.duration)}\n\n`;
            
            if (meeting.summary) {
                message += `*Resumo Geral:*\n${meeting.summary.general}\n\n`;
                
                if (meeting.summary.points.length > 0) {
                    message += `*Principais Pontos:*\n`;
                    meeting.summary.points.forEach(point => message += `窶｢ ${point}\n`);
                    message += `\n`;
                }
                
                if (meeting.summary.decisions.length > 0) {
                    message += `*Decisﾃｵes Tomadas:*\n`;
                    meeting.summary.decisions.forEach(decision => message += `窶｢ ${decision}\n`);
                    message += `\n`;
                }
                
                if (meeting.summary.actions.length > 0) {
                    message += `*Aﾃｧﾃｵes e Tarefas:*\n`;
                    meeting.summary.actions.forEach(action => message += `窶｢ ${action}\n`);
                }
            } else {
                message += `_Resumo ainda nﾃ｣o gerado_`;
            }
            
            const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
        }
        
        // ==================== DELETE ====================
        async function deleteMeetingConfirm() {
            if (confirm('Tem certeza que deseja excluir esta reuniﾃ｣o? Esta aﾃｧﾃ｣o nﾃ｣o pode ser desfeita.')) {
                await deleteMeeting(currentMeetingId);
                showScreen('home');
            }
        }
        
        // ==================== EDITAR Tﾃ控ULO E TAGS ====================
        async function editTitle() {
            const meeting = await getMeeting(currentMeetingId);
            const newTitle = prompt('Digite o novo tﾃｭtulo:', meeting.title);
            
            if (newTitle && newTitle.trim() !== '' && newTitle !== meeting.title) {
                meeting.title = newTitle.trim();
                await updateMeeting(meeting);
                document.getElementById('detail-title').textContent = meeting.title;
                alert('Tﾃｭtulo atualizado!');
            }
        }
        
        async function editTags() {
            const meeting = await getMeeting(currentMeetingId);
            const currentTags = meeting.tags || [];
            const tagsString = currentTags.join(', ');
            
            const newTagsString = prompt('Edite as tags (separadas por vﾃｭrgula):\n\nExemplo: operaﾃｧﾃｵes, loja07, gestores', tagsString);
            
            if (newTagsString !== null) {
                const newTags = newTagsString
                    .split(',')
                    .map(tag => tag.trim())
                    .filter(tag => tag.length > 0);
                
                meeting.tags = newTags;
                await updateMeeting(meeting);
                
                // Atualizar visualizaﾃｧﾃ｣o
                const tagsContainer = document.getElementById('detail-tags');
                if (newTags.length > 0) {
                    tagsContainer.innerHTML = newTags.map(tag => `
                        <span style="background: #dbeafe; color: #1e40af; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.875rem; display: inline-block; margin-right: 0.5rem;">${tag}</span>
                    `).join('');
                } else {
                    tagsContainer.innerHTML = '<span class="text-sm text-gray">Nenhuma tag</span>';
                }
                
                alert('Tags atualizadas!');
                
                // Atualizar filtro de tags na home
                await renderTagFilter();
            }
        }
        
        // ==================== EVENT LISTENERS ====================
        document.getElementById('tag-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && e.target.value.trim()) {
                const tag = e.target.value.trim();
                if (!selectedTags.includes(tag)) {
                    selectedTags.push(tag);
                    renderSelectedTags();
                }
                e.target.value = '';
            }
        });
        
        // ==================== INIT ====================
        async function init() {
            await initDB();
            loadMeetings();
            
            if ('serviceWorker' in navigator) {
                try {
                    await navigator.serviceWorker.register('sw.js');
                } catch (e) {
                    console.log('Service worker nﾃ｣o disponﾃｭvel');
                }
            }
        }
        
        init();
    </script>
</body>
</html>
