<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#3B82F6">
    <meta name="description" content="App para gravar e resumir reuni√µes com IA">
    <title>Minhas Reuni√µes</title>
    
    <!-- PWA Meta Tags -->
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNDAgMjQwIj48cmVjdCB3aWR0aD0iMjQwIiBoZWlnaHQ9IjI0MCIgZmlsbD0iIzNCODJGNiIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBmb250LXNpemU9IjEyMCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iIGZpbGw9IndoaXRlIj7wn46kPC90ZXh0Pjwvc3ZnPg==">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f9fafb;
            min-height: 100vh;
            color: #1f2937;
        }
        
        .container {
            max-width: 768px;
            margin: 0 auto;
            padding: 1rem;
        }
        
        .btn {
            display: block;
            width: 100%;
            padding: 1rem;
            border: none;
            border-radius: 0.5rem;
            font-size: 1.125rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }
        
        .btn-primary {
            background: #3b82f6;
            color: white;
        }
        
        .btn-primary:hover {
            background: #2563eb;
        }
        
        .btn-danger {
            background: #ef4444;
            color: white;
        }
        
        .btn-danger:hover {
            background: #dc2626;
        }
        
        .btn-dark {
            background: #1f2937;
            color: white;
        }
        
        .btn-dark:hover {
            background: #111827;
        }
        
        .card {
            background: white;
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 1rem;
        }
        
        .card:hover {
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 1rem;
            margin-bottom: 1rem;
        }
        
        .input:focus {
            outline: none;
            border-color: #3b82f6;
        }
        
        .hidden {
            display: none !important;
        }
        
        .recording-pulse {
            animation: pulse 1.5s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .timer {
            font-size: 3rem;
            font-weight: bold;
            font-variant-numeric: tabular-nums;
            font-family: 'Courier New', monospace;
            text-align: center;
            margin: 2rem 0;
        }
        
        .tag-chip {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            background: #3b82f6;
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.875rem;
            margin: 0.25rem;
        }
        
        .tag-chip button {
            background: transparent;
            border: none;
            color: white;
            cursor: pointer;
            padding: 0.125rem;
            display: flex;
            align-items: center;
        }
        
        .tag-filter-btn {
            display: inline-block;
            padding: 0.5rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.875rem;
            border: none;
            cursor: pointer;
            margin: 0.25rem;
        }
        
        .tag-filter-btn.active {
            background: #3b82f6;
            color: white;
        }
        
        .tag-filter-btn.inactive {
            background: #e5e7eb;
            color: #374151;
        }
        
        .meeting-card {
            cursor: pointer;
        }
        
        .icon-btn {
            background: transparent;
            border: none;
            padding: 0.5rem;
            cursor: pointer;
            color: #3b82f6;
        }
        
        .icon-btn.danger {
            color: #ef4444;
        }
        
        .loader {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 3rem;
            height: 3rem;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        h1 {
            font-size: 1.875rem;
            font-weight: bold;
            margin-bottom: 1rem;
        }
        
        h2 {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }
        
        h3 {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        
        .text-gray {
            color: #6b7280;
        }
        
        .text-sm {
            font-size: 0.875rem;
        }
        
        .flex {
            display: flex;
        }
        
        .items-center {
            align-items: center;
        }
        
        .justify-between {
            justify-content: space-between;
        }
        
        .gap-2 {
            gap: 0.5rem;
        }
        
        .mb-1 { margin-bottom: 0.25rem; }
        .mb-2 { margin-bottom: 0.5rem; }
        .mb-3 { margin-bottom: 0.75rem; }
        .mb-4 { margin-bottom: 1rem; }
        
        .mt-4 { margin-top: 1rem; }
        
        .p-4 { padding: 1rem; }
        
        ul {
            list-style: none;
        }
        
        ul li {
            margin-bottom: 0.5rem;
            line-height: 1.5;
        }
        
        audio {
            width: 100%;
            margin: 1rem 0;
        }
        
        .recording-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            background: #fee2e2;
            color: #dc2626;
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            font-weight: 600;
        }
        
        .recording-dot {
            width: 0.75rem;
            height: 0.75rem;
            background: #dc2626;
            border-radius: 50%;
        }
        
        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: #9ca3af;
        }
        
        .empty-state svg {
            width: 5rem;
            height: 5rem;
            margin: 0 auto 1rem;
            opacity: 0.5;
        }
        
        .back-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            color: #3b82f6;
            background: transparent;
            border: none;
            font-size: 1rem;
            cursor: pointer;
            margin-bottom: 1rem;
        }
        
        .section-icon {
            width: 1.25rem;
            height: 1.25rem;
            margin-right: 0.5rem;
        }
        
        .section-header {
            display: flex;
            align-items: flex-start;
            margin-bottom: 0.75rem;
        }
    </style>
</head>
<body>
    
    <!-- Tela Inicial -->
    <div id="home-screen" class="container">
        <div class="flex justify-between items-center mb-4">
            <h1>Reuni√µes</h1>
            <button class="icon-btn" onclick="configureApi()" title="Configurar API">
                <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                </svg>
            </button>
        </div>
        
        <div id="tag-filter" class="mb-4 hidden">
            <p class="text-sm text-gray mb-2">Filtrar por:</p>
            <div id="tag-filter-chips"></div>
        </div>
        
        <button class="btn btn-primary mb-4" onclick="showRecordingScreen()">
            + Nova Grava√ß√£o
        </button>
        
        <div id="meetings-list"></div>
        
        <div id="empty-state" class="empty-state hidden">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"/>
            </svg>
            <p>Nenhuma reuni√£o gravada ainda</p>
            <p class="text-sm">Clique em "Nova Grava√ß√£o" para come√ßar</p>
        </div>
    </div>
    
    <!-- Tela de Grava√ß√£o -->
    <div id="recording-screen" class="container hidden">
        <button class="back-btn" onclick="backToHome()">
            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
            </svg>
            Voltar
        </button>
        
        <div class="card">
            <input type="text" id="meeting-title" class="input" placeholder="T√≠tulo da reuni√£o">
            
            <label class="text-sm text-gray">Tags (opcional)</label>
            <div id="selected-tags" class="mb-2"></div>
            <input type="text" id="tag-input" class="input" placeholder="Digite uma tag e pressione Enter">
            
            <div style="text-align: center;">
                <div id="recording-indicator" class="hidden mb-3">
                    <span class="recording-indicator">
                        <span class="recording-dot recording-pulse"></span>
                        Gravando
                    </span>
                </div>
                <div id="timer" class="timer">00:00:00</div>
                <p id="recording-date" class="text-sm text-gray"></p>
            </div>
            
            <button id="start-recording" class="btn btn-danger mt-4" onclick="startRecording()">
                Iniciar Grava√ß√£o
            </button>
            <button id="stop-recording" class="btn btn-dark mt-4 hidden" onclick="stopRecording()">
                Parar Grava√ß√£o
            </button>
        </div>
    </div>
    
    <!-- Tela de Detalhes -->
    <div id="detail-screen" class="container hidden">
        <button class="back-btn" onclick="backToList()">
            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
            </svg>
            Voltar
        </button>
        
        <div class="flex justify-between items-center mb-3">
            <div style="flex: 1; display: flex; align-items: center; gap: 0.5rem;">
                <h2 id="detail-title"></h2>
                <button class="icon-btn" onclick="editTitle()" title="Editar t√≠tulo" style="padding: 0.25rem;">
                    <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                    </svg>
                </button>
            </div>
            <div class="flex gap-2">
                <button class="icon-btn" onclick="shareOnWhatsApp()">
                    <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"/>
                    </svg>
                </button>
                <button class="icon-btn danger" onclick="deleteMeetingConfirm()">
                    <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                    </svg>
                </button>
            </div>
        </div>
        
        <div class="text-sm text-gray mb-2">
            <div id="detail-date"></div>
            <div id="detail-time"></div>
            <div id="detail-duration"></div>
        </div>
        
        <div class="mb-4">
            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                <span class="text-sm text-gray">Tags:</span>
                <button class="icon-btn" onclick="editTags()" title="Editar tags" style="padding: 0.25rem;">
                    <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                    </svg>
                </button>
            </div>
            <div id="detail-tags"></div>
        </div>
        
        <div class="card">
            <h3>√Åudio da Reuni√£o</h3>
            <audio id="audio-player" controls></audio>
        </div>
        
        <button id="generate-summary-btn" class="btn btn-primary mb-4" onclick="generateSummary()">
            Gerar Resumo com IA
        </button>
        
        <div id="loading-summary" class="card hidden" style="text-align: center;">
            <div class="loader"></div>
            <p class="mt-4 text-gray">Transcrevendo √°udio com Whisper...</p>
            <p class="text-sm text-gray">Depois vou gerar o resumo. Aguarde alguns minutos.</p>
        </div>
        
        <div id="summary-content" class="hidden">
            <div class="card">
                <h3>Resumo Geral</h3>
                <p id="summary-general" class="text-sm"></p>
            </div>
            
            <div class="card">
                <div class="section-header">
                    <svg class="section-icon" style="color: #eab308;" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                    </svg>
                    <h3>Principais Pontos</h3>
                </div>
                <ul id="summary-points" class="text-sm"></ul>
            </div>
            
            <div class="card">
                <div class="section-header">
                    <svg class="section-icon" style="color: #22c55e;" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                    </svg>
                    <h3>Decis√µes Tomadas</h3>
                </div>
                <ul id="summary-decisions" class="text-sm"></ul>
            </div>
            
            <div class="card">
                <div class="section-header">
                    <svg class="section-icon" style="color: #3b82f6;" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"/>
                        <path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"/>
                    </svg>
                    <h3>A√ß√µes e Tarefas</h3>
                </div>
                <ul id="summary-actions" class="text-sm"></ul>
            </div>
            
            <div class="card">
                <h3>Transcri√ß√£o Completa</h3>
                <p id="transcript-text" class="text-sm" style="white-space: pre-wrap;"></p>
            </div>
        </div>
    </div>

    <script>
        // Estado da aplica√ß√£o
        let db;
        let currentScreen = 'home';
        let isRecording = false;
        let mediaRecorder = null;
        let audioChunks = [];
        let startTime = null;
        let timerInterval = null;
        let currentMeetingId = null;
        let selectedTags = [];
        let filterTag = null;
        
        // ==================== INDEXEDDB ====================
        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('ReunicoesDB', 1);
                
                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    db = request.result;
                    resolve(db);
                };
                
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains('meetings')) {
                        const objectStore = db.createObjectStore('meetings', { keyPath: 'id', autoIncrement: true });
                        objectStore.createIndex('date', 'date', { unique: false });
                        objectStore.createIndex('tags', 'tags', { unique: false, multiEntry: true });
                    }
                };
            });
        }
        
        function saveMeeting(meeting) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['meetings'], 'readwrite');
                const objectStore = transaction.objectStore('meetings');
                const request = objectStore.add(meeting);
                
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }
        
        function getAllMeetings() {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['meetings'], 'readonly');
                const objectStore = transaction.objectStore('meetings');
                const request = objectStore.getAll();
                
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }
        
        function getMeeting(id) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['meetings'], 'readonly');
                const objectStore = transaction.objectStore('meetings');
                const request = objectStore.get(id);
                
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }
        
        function updateMeeting(meeting) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['meetings'], 'readwrite');
                const objectStore = transaction.objectStore('meetings');
                const request = objectStore.put(meeting);
                
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }
        
        function deleteMeeting(id) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['meetings'], 'readwrite');
                const objectStore = transaction.objectStore('meetings');
                const request = objectStore.delete(id);
                
                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }
        
        // ==================== FORMATA√á√ÉO ====================
        function formatDate(date) {
            return new Date(date).toLocaleDateString('pt-BR', {
                day: '2-digit',
                month: 'long',
                year: 'numeric'
            });
        }
        
        function formatTime(date) {
            return new Date(date).toLocaleTimeString('pt-BR', {
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        function formatDuration(ms) {
            const seconds = Math.floor(ms / 1000);
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            
            if (hours > 0) return `${hours}h ${minutes}m ${secs}s`;
            if (minutes > 0) return `${minutes}m ${secs}s`;
            return `${secs}s`;
        }
        
        function formatTimer(ms) {
            const seconds = Math.floor(ms / 1000);
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            
            return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        }
        
        // ==================== NAVEGA√á√ÉO ====================
        function showScreen(screen) {
            document.getElementById('home-screen').classList.add('hidden');
            document.getElementById('recording-screen').classList.add('hidden');
            document.getElementById('detail-screen').classList.add('hidden');
            
            document.getElementById(screen + '-screen').classList.remove('hidden');
            currentScreen = screen;
            
            if (screen === 'home') loadMeetings();
        }
        
        function showRecordingScreen() {
            showScreen('recording');
        }
        
        function backToHome() {
            if (isRecording) {
                if (confirm('A grava√ß√£o est√° em andamento. Deseja cancelar?')) {
                    if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                        mediaRecorder.stop();
                    }
                    isRecording = false;
                    showScreen('home');
                }
            } else {
                showScreen('home');
            }
        }
        
        function backToList() {
            showScreen('home');
        }
        
        // ==================== TIMER ====================
        function startTimer() {
            startTime = Date.now();
            timerInterval = setInterval(() => {
                const elapsed = Date.now() - startTime;
                document.getElementById('timer').textContent = formatTimer(elapsed);
            }, 1000);
        }
        
        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            return Date.now() - startTime;
        }
        
        function resetTimer() {
            document.getElementById('timer').textContent = '00:00:00';
        }
        
        // ==================== GRAVA√á√ÉO ====================
        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                
                mediaRecorder.ondataavailable = (event) => {
                    audioChunks.push(event.data);
                };
                
                mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    await saveRecording(audioBlob);
                    stream.getTracks().forEach(track => track.stop());
                };
                
                mediaRecorder.start();
                isRecording = true;
                
                document.getElementById('start-recording').classList.add('hidden');
                document.getElementById('stop-recording').classList.remove('hidden');
                document.getElementById('recording-indicator').classList.remove('hidden');
                document.getElementById('meeting-title').disabled = true;
                document.getElementById('tag-input').disabled = true;
                
                startTimer();
                
                document.getElementById('recording-date').textContent = 
                    `${formatDate(Date.now())} - ${formatTime(Date.now())}`;
                
            } catch (error) {
                alert('Erro ao acessar o microfone. Verifique as permiss√µes no navegador.');
                console.error(error);
            }
        }
        
        function stopRecording() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                isRecording = false;
                stopTimer();
            }
        }
        
        async function saveRecording(audioBlob) {
            const title = document.getElementById('meeting-title').value || 'Reuni√£o sem t√≠tulo';
            const recordingDate = new Date(startTime);
            const duration = Date.now() - startTime;
            
            const reader = new FileReader();
            reader.readAsDataURL(audioBlob);
            reader.onloadend = async () => {
                const audioBase64 = reader.result;
                
                const meeting = {
                    title: title,
                    date: recordingDate.toISOString(),
                    duration: duration,
                    audio: audioBase64,
                    tags: selectedTags,
                    summary: null,
                    transcript: null
                };
                
                await saveMeeting(meeting);
                
                document.getElementById('meeting-title').value = '';
                document.getElementById('meeting-title').disabled = false;
                document.getElementById('tag-input').disabled = false;
                selectedTags = [];
                renderSelectedTags();
                resetTimer();
                
                showScreen('home');
                alert('Reuni√£o salva com sucesso!');
            };
        }
        
        // ==================== TAGS ====================
        function renderSelectedTags() {
            const container = document.getElementById('selected-tags');
            container.innerHTML = '';
            
            selectedTags.forEach(tag => {
                const chip = document.createElement('span');
                chip.className = 'tag-chip';
                chip.innerHTML = `
                    ${tag}
                    <button onclick="removeTag('${tag}')">
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
                        </svg>
                    </button>
                `;
                container.appendChild(chip);
            });
        }
        
        function removeTag(tag) {
            selectedTags = selectedTags.filter(t => t !== tag);
            renderSelectedTags();
        }
        
        async function getAllTags() {
            const meetings = await getAllMeetings();
            const tagsSet = new Set();
            meetings.forEach(meeting => {
                if (meeting.tags) {
                    meeting.tags.forEach(tag => tagsSet.add(tag));
                }
            });
            return Array.from(tagsSet);
        }
        
        async function renderTagFilter() {
            const tags = await getAllTags();
            const container = document.getElementById('tag-filter-chips');
            const filterContainer = document.getElementById('tag-filter');
            
            if (tags.length === 0) {
                filterContainer.classList.add('hidden');
                return;
            }
            
            filterContainer.classList.remove('hidden');
            container.innerHTML = '';
            
            const allBtn = document.createElement('button');
            allBtn.className = `tag-filter-btn ${!filterTag ? 'active' : 'inactive'}`;
            allBtn.textContent = 'Todas';
            allBtn.onclick = () => {
                filterTag = null;
                loadMeetings();
            };
            container.appendChild(allBtn);
            
            tags.forEach(tag => {
                const btn = document.createElement('button');
                btn.className = `tag-filter-btn ${filterTag === tag ? 'active' : 'inactive'}`;
                btn.textContent = tag;
                btn.onclick = () => {
                    filterTag = tag;
                    loadMeetings();
                };
                container.appendChild(btn);
            });
        }
        
        // ==================== LISTA ====================
        async function loadMeetings() {
            let meetings = await getAllMeetings();
            
            if (filterTag) {
                meetings = meetings.filter(m => m.tags && m.tags.includes(filterTag));
            }
            
            meetings.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            const container = document.getElementById('meetings-list');
            const emptyState = document.getElementById('empty-state');
            
            if (meetings.length === 0) {
                container.innerHTML = '';
                emptyState.classList.remove('hidden');
            } else {
                emptyState.classList.add('hidden');
                container.innerHTML = meetings.map(meeting => `
                    <div class="card meeting-card" onclick="viewMeeting(${meeting.id})">
                        <h3>${meeting.title}</h3>
                        <div class="text-sm text-gray mb-2">
                            <div>${formatDate(meeting.date)} - ${formatTime(meeting.date)}</div>
                            <div>Dura√ß√£o: ${formatDuration(meeting.duration)}</div>
                        </div>
                        ${meeting.tags && meeting.tags.length > 0 ? `
                            <div>
                                ${meeting.tags.map(tag => `
                                    <span style="font-size: 0.75rem; background: #dbeafe; color: #1e40af; padding: 0.25rem 0.5rem; border-radius: 0.25rem; display: inline-block; margin-right: 0.25rem;">${tag}</span>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                `).join('');
            }
            
            await renderTagFilter();
        }
        
        // ==================== DETALHES ====================
        async function viewMeeting(id) {
            currentMeetingId = id;
            const meeting = await getMeeting(id);
            
            document.getElementById('detail-title').textContent = meeting.title;
            document.getElementById('detail-date').textContent = formatDate(meeting.date);
            document.getElementById('detail-time').textContent = formatTime(meeting.date);
            document.getElementById('detail-duration').textContent = `Dura√ß√£o: ${formatDuration(meeting.duration)}`;
            
            const tagsContainer = document.getElementById('detail-tags');
            if (meeting.tags && meeting.tags.length > 0) {
                tagsContainer.innerHTML = meeting.tags.map(tag => `
                    <span style="background: #dbeafe; color: #1e40af; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.875rem; display: inline-block; margin-right: 0.5rem;">${tag}</span>
                `).join('');
            } else {
                tagsContainer.innerHTML = '<span class="text-sm text-gray">Nenhuma tag</span>';
            }
            
            const audioPlayer = document.getElementById('audio-player');
            audioPlayer.src = meeting.audio;
            
            if (meeting.summary) {
                document.getElementById('generate-summary-btn').classList.add('hidden');
                document.getElementById('summary-content').classList.remove('hidden');
                
                document.getElementById('summary-general').textContent = meeting.summary.general;
                document.getElementById('summary-points').innerHTML = meeting.summary.points
                    .map(point => `<li>‚Ä¢ ${point}</li>`).join('');
                document.getElementById('summary-decisions').innerHTML = meeting.summary.decisions
                    .map(decision => `<li>‚Ä¢ ${decision}</li>`).join('');
                document.getElementById('summary-actions').innerHTML = meeting.summary.actions
                    .map(action => `<li>‚Ä¢ ${action}</li>`).join('');
                document.getElementById('transcript-text').textContent = meeting.transcript;
            } else {
                document.getElementById('generate-summary-btn').classList.remove('hidden');
                document.getElementById('summary-content').classList.add('hidden');
            }
            
            showScreen('detail');
        }
        
        // ==================== CONFIGURA√á√ÉO DA API ====================
        // IMPORTANTE: Pegue sua chave de API gratuita em https://console.groq.com
        const GROQ_API_KEY = localStorage.getItem('groq_api_key') || '';
        
        function checkApiKey() {
            if (!GROQ_API_KEY && !localStorage.getItem('groq_api_key')) {
                const key = prompt('Para usar a IA, voc√™ precisa de uma chave de API gratuita da Groq.\n\n1. V√° para https://console.groq.com\n2. Crie uma conta gr√°tis\n3. V√° em "API Keys"\n4. Crie uma nova chave\n5. Cole aqui:\n\n(A chave ficar√° salva no seu celular)');
                
                if (key) {
                    localStorage.setItem('groq_api_key', key.trim());
                    location.reload();
                    return true;
                }
                return false;
            }
            return true;
        }
        
        function configureApi() {
            const currentKey = localStorage.getItem('groq_api_key');
            let message = 'Configure sua chave de API da Groq (100% GR√ÅTIS):\n\n';
            
            if (currentKey) {
                message += '‚úÖ Voc√™ j√° tem uma chave configurada!\n\n';
                message += 'Para alterar, cole uma nova chave abaixo.\n';
                message += 'Para remover, deixe em branco e clique OK.\n\n';
            } else {
                message += 'üìù Como conseguir sua chave:\n\n';
                message += '1. Acesse: https://console.groq.com\n';
                message += '2. Crie uma conta gr√°tis\n';
                message += '3. V√° em "API Keys"\n';
                message += '4. Clique em "Create API Key"\n';
                message += '5. Copie a chave\n';
                message += '6. Cole aqui:\n\n';
            }
            
            const key = prompt(message, currentKey || '');
            
            if (key === null) return; // Cancelou
            
            if (key.trim() === '') {
                localStorage.removeItem('groq_api_key');
                alert('Chave de API removida!');
            } else {
                localStorage.setItem('groq_api_key', key.trim());
                alert('Chave de API salva com sucesso! ‚úÖ');
            }
        }
        
        // ==================== IA ====================
        async function generateSummary() {
            const meeting = await getMeeting(currentMeetingId);
            
            // Verificar API key
            const apiKey = localStorage.getItem('groq_api_key');
            if (!apiKey) {
                if (!checkApiKey()) {
                    alert('Voc√™ precisa configurar a chave de API da Groq para usar a IA.\n\nEla √© 100% gr√°tis! Veja as instru√ß√µes.');
                    return;
                }
            }
            
            document.getElementById('generate-summary-btn').classList.add('hidden');
            document.getElementById('loading-summary').classList.remove('hidden');
            
            try {
                console.log('=== INICIANDO GERA√á√ÉO DE RESUMO ===');
                console.log('ID da reuni√£o:', currentMeetingId);
                console.log('√Åudio presente:', meeting.audio ? 'Sim' : 'N√£o');
                
                // Transcrever o √°udio usando Whisper da Groq
                console.log('Passo 1: Transcrevendo √°udio...');
                const transcript = await transcribeWithWhisper(meeting.audio, apiKey);
                console.log('Transcri√ß√£o conclu√≠da! Tamanho:', transcript.length, 'caracteres');
                console.log('Primeiros 200 caracteres:', transcript.substring(0, 200));
                
                // Gerar resumo com a transcri√ß√£o
                console.log('Passo 2: Gerando resumo...');
                const summary = await generateSummaryFromTranscript(transcript);
                console.log('Resumo gerado:', summary);
                
                meeting.transcript = transcript;
                meeting.summary = summary;
                await updateMeeting(meeting);
                console.log('Reuni√£o atualizada no banco!');
                
                document.getElementById('loading-summary').classList.add('hidden');
                document.getElementById('summary-content').classList.remove('hidden');
                
                document.getElementById('summary-general').textContent = summary.general;
                document.getElementById('summary-points').innerHTML = summary.points
                    .map(point => `<li>‚Ä¢ ${point}</li>`).join('');
                document.getElementById('summary-decisions').innerHTML = summary.decisions
                    .map(decision => `<li>‚Ä¢ ${decision}</li>`).join('');
                document.getElementById('summary-actions').innerHTML = summary.actions
                    .map(action => `<li>‚Ä¢ ${action}</li>`).join('');
                document.getElementById('transcript-text').textContent = transcript;
                
                console.log('=== RESUMO CONCLU√çDO COM SUCESSO ===');
                
            } catch (error) {
                console.error('=== ERRO AO GERAR RESUMO ===');
                console.error('Tipo de erro:', error.name);
                console.error('Mensagem:', error.message);
                console.error('Stack:', error.stack);
                
                let errorMsg = 'Erro ao gerar resumo.';
                if (error.message.includes('401') || error.message.includes('403')) {
                    errorMsg = 'Chave de API inv√°lida. Clique no √≠cone ‚öôÔ∏è para configurar novamente.';
                    localStorage.removeItem('groq_api_key');
                } else if (error.message.includes('audio')) {
                    errorMsg = 'Erro ao processar o √°udio. Tente gravar novamente.';
                }
                
                alert(errorMsg + '\n\nDetalhes t√©cnicos: ' + error.message + '\n\nVerifique o console do navegador (F12) para mais informa√ß√µes.');
                document.getElementById('loading-summary').classList.add('hidden');
                document.getElementById('generate-summary-btn').classList.remove('hidden');
            }
        }
        
        async function transcribeWithWhisper(audioBase64, apiKey) {
            try {
                // Converter base64 para blob
                const response = await fetch(audioBase64);
                const blob = await response.blob();
                
                // Converter webm para formato compat√≠vel se necess√°rio
                // Whisper aceita diversos formatos incluindo webm
                const audioFile = new File([blob], 'audio.webm', { type: 'audio/webm' });
                
                // Criar FormData
                const formData = new FormData();
                formData.append('file', audioFile);
                formData.append('model', 'whisper-large-v3');
                formData.append('language', 'pt');
                formData.append('response_format', 'verbose_json'); // Mudado para pegar timestamps e poss√≠vel diariza√ß√£o
                formData.append('timestamp_granularities[]', 'segment');
                
                // Fazer requisi√ß√£o para Whisper API da Groq
                const whisperResponse = await fetch('https://api.groq.com/openai/v1/audio/transcriptions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: formData
                });
                
                if (!whisperResponse.ok) {
                    const errorData = await whisperResponse.text();
                    throw new Error(`Whisper API error ${whisperResponse.status}: ${errorData}`);
                }
                
                const data = await whisperResponse.json();
                
                // Montar transcri√ß√£o com timestamps e tentativa de identificar mudan√ßas de speaker
                let transcript = '';
                let currentSpeaker = 1;
                let lastPause = 0;
                
                if (data.segments && data.segments.length > 0) {
                    data.segments.forEach((segment, index) => {
                        // Se houve uma pausa longa (>2s), pode ser outro speaker
                        if (index > 0 && segment.start - lastPause > 2.0) {
                            currentSpeaker++;
                            transcript += '\n\n';
                        }
                        
                        // Adicionar timestamp e texto
                        const minutes = Math.floor(segment.start / 60);
                        const seconds = Math.floor(segment.start % 60);
                        transcript += `[${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}] ${segment.text.trim()}\n`;
                        
                        lastPause = segment.end;
                    });
                } else {
                    // Fallback para texto simples
                    transcript = data.text || '';
                }
                
                if (!transcript || transcript.trim().length < 10) {
                    throw new Error('Transcri√ß√£o vazia ou muito curta. Verifique se o √°udio tem fala clara.');
                }
                
                return transcript.trim();
                
            } catch (error) {
                console.error('Erro na transcri√ß√£o:', error);
                throw new Error(`Falha ao transcrever √°udio: ${error.message}`);
            }
        }
        
        async function generateSummaryFromTranscript(transcript) {
            const apiKey = localStorage.getItem('groq_api_key');
            
            console.log('===== INICIANDO GERA√á√ÉO DE RESUMO =====');
            console.log('API Key existe?', !!apiKey);
            console.log('API Key (primeiros 10 chars):', apiKey ? apiKey.substring(0, 10) + '...' : 'NENHUMA');
            console.log('Tamanho da transcri√ß√£o:', transcript.length);
            
            if (!apiKey || apiKey.length < 20) {
                alert('API Key inv√°lida ou n√£o configurada!\n\nClique no √≠cone ‚öôÔ∏è para configurar.');
                throw new Error('API Key n√£o configurada');
            }
            
            // Limpar timestamps da transcri√ß√£o
            const cleanTranscript = transcript.replace(/\[\d{2}:\d{2}\]/g, '').trim();
            console.log('Transcri√ß√£o limpa (primeiros 300 chars):', cleanTranscript.substring(0, 300));
            
            // Limitar tamanho se muito grande
            let transcriptToSend = cleanTranscript;
            if (cleanTranscript.length > 7000) {
                transcriptToSend = cleanTranscript.substring(0, 7000);
                console.log('Transcri√ß√£o truncada para 7000 caracteres');
            }
            
            const systemMsg = "Voc√™ √© um assistente que resume reuni√µes em portugu√™s. Responda APENAS com JSON v√°lido.";
            const userMsg = `Resuma esta reuni√£o:

${transcriptToSend}

Retorne JSON neste formato exato:
{
  "general": "Resumo em 2-3 frases do que foi discutido",
  "points": ["Ponto 1", "Ponto 2", "Ponto 3"],
  "decisions": ["Decis√£o 1", "Decis√£o 2"],
  "actions": ["A√ß√£o 1", "A√ß√£o 2"]
}

Se n√£o houver decis√µes, use: ["Nenhuma decis√£o espec√≠fica registrada"]
Se n√£o houver a√ß√µes, use: ["Nenhuma a√ß√£o espec√≠fica registrada"]`;

            try {
                console.log('Fazendo chamada para API Groq...');
                
                const requestBody = {
                    model: "llama-3.3-70b-versatile",
                    messages: [
                        { role: "system", content: systemMsg },
                        { role: "user", content: userMsg }
                    ],
                    temperature: 0.5,
                    max_tokens: 1024
                };
                
                console.log('Modelo:', requestBody.model);
                console.log('Max tokens:', requestBody.max_tokens);
                
                const response = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${apiKey}`
                    },
                    body: JSON.stringify(requestBody)
                });
                
                console.log('Status da resposta:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('ERRO da API:');
                    console.error('Status:', response.status);
                    console.error('Texto completo:', errorText);
                    
                    let errorMsg = `API retornou status ${response.status}`;
                    
                    if (response.status === 400) {
                        errorMsg = 'Requisi√ß√£o inv√°lida (400). Poss√≠veis causas:\n';
                        errorMsg += '- API Key pode estar incorreta\n';
                        errorMsg += '- Modelo pode n√£o existir\n';
                        errorMsg += '- Formato da requisi√ß√£o inv√°lido\n\n';
                        errorMsg += 'Detalhes: ' + errorText.substring(0, 200);
                    } else if (response.status === 401) {
                        errorMsg = 'API Key inv√°lida (401). Reconfigure no √≠cone ‚öôÔ∏è';
                    } else if (response.status === 429) {
                        errorMsg = 'Limite de requisi√ß√µes atingido (429). Aguarde alguns minutos.';
                    }
                    
                    throw new Error(errorMsg);
                }
                
                const data = await response.json();
                console.log('Resposta recebida:', data);
                
                if (!data.choices || !data.choices[0]) {
                    console.error('Resposta sem choices');
                    throw new Error('Resposta inv√°lida da API');
                }
                
                let responseText = data.choices[0].message.content;
                console.log('Conte√∫do da resposta:', responseText);
                
                // Limpar markdown
                responseText = responseText.replace(/```json\n?/g, "").replace(/```\n?/g, "").trim();
                console.log('Texto limpo:', responseText);
                
                // Parse do JSON
                let summary;
                try {
                    summary = JSON.parse(responseText);
                    console.log('JSON parseado com sucesso!', summary);
                } catch (e) {
                    console.error('ERRO ao parsear JSON:', e);
                    console.error('Texto que tentou parsear:', responseText);
                    throw new Error('IA n√£o retornou JSON v√°lido');
                }
                
                // Validar campos
                if (!summary.general) summary.general = "Resumo n√£o dispon√≠vel";
                if (!Array.isArray(summary.points) || summary.points.length === 0) {
                    summary.points = ["Veja a transcri√ß√£o completa"];
                }
                if (!Array.isArray(summary.decisions) || summary.decisions.length === 0) {
                    summary.decisions = ["Nenhuma decis√£o espec√≠fica registrada"];
                }
                if (!Array.isArray(summary.actions) || summary.actions.length === 0) {
                    summary.actions = ["Nenhuma a√ß√£o espec√≠fica registrada"];
                }
                
                console.log('===== RESUMO GERADO COM SUCESSO =====');
                console.log(summary);
                return summary;
                
            } catch (error) {
                console.error('===== ERRO AO GERAR RESUMO =====');
                console.error('Tipo:', error.name);
                console.error('Mensagem:', error.message);
                console.error('Stack:', error.stack);
                
                alert('ERRO ao gerar resumo:\n\n' + error.message + '\n\nAbra o Console (F12) para ver detalhes.');
                
                return {
                    general: "ERRO: " + error.message,
                    points: ["Abra o console do navegador (F12) para ver o erro completo"],
                    decisions: ["Erro ao processar"],
                    actions: ["Tente novamente ou entre em contato"]
                };
            }
        }
        
        // ==================== WHATSAPP ====================
        async function shareOnWhatsApp() {
            const meeting = await getMeeting(currentMeetingId);
            
            let message = `üìù *${meeting.title}*\n\n`;
            message += `üìÖ ${formatDate(meeting.date)}\n`;
            message += `üïí ${formatTime(meeting.date)}\n`;
            message += `‚è±Ô∏è Dura√ß√£o: ${formatDuration(meeting.duration)}\n\n`;
            
            if (meeting.summary) {
                message += `*Resumo Geral:*\n${meeting.summary.general}\n\n`;
                
                if (meeting.summary.points.length > 0) {
                    message += `*Principais Pontos:*\n`;
                    meeting.summary.points.forEach(point => message += `‚Ä¢ ${point}\n`);
                    message += `\n`;
                }
                
                if (meeting.summary.decisions.length > 0) {
                    message += `*Decis√µes Tomadas:*\n`;
                    meeting.summary.decisions.forEach(decision => message += `‚Ä¢ ${decision}\n`);
                    message += `\n`;
                }
                
                if (meeting.summary.actions.length > 0) {
                    message += `*A√ß√µes e Tarefas:*\n`;
                    meeting.summary.actions.forEach(action => message += `‚Ä¢ ${action}\n`);
                }
            } else {
                message += `_Resumo ainda n√£o gerado_`;
            }
            
            const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
        }
        
        // ==================== DELETE ====================
        async function deleteMeetingConfirm() {
            if (confirm('Tem certeza que deseja excluir esta reuni√£o? Esta a√ß√£o n√£o pode ser desfeita.')) {
                await deleteMeeting(currentMeetingId);
                showScreen('home');
            }
        }
        
        // ==================== EDITAR T√çTULO E TAGS ====================
        async function editTitle() {
            const meeting = await getMeeting(currentMeetingId);
            const newTitle = prompt('Digite o novo t√≠tulo:', meeting.title);
            
            if (newTitle && newTitle.trim() !== '' && newTitle !== meeting.title) {
                meeting.title = newTitle.trim();
                await updateMeeting(meeting);
                document.getElementById('detail-title').textContent = meeting.title;
                alert('T√≠tulo atualizado!');
            }
        }
        
        async function editTags() {
            const meeting = await getMeeting(currentMeetingId);
            const currentTags = meeting.tags || [];
            const tagsString = currentTags.join(', ');
            
            const newTagsString = prompt('Edite as tags (separadas por v√≠rgula):\n\nExemplo: opera√ß√µes, loja07, gestores', tagsString);
            
            if (newTagsString !== null) {
                const newTags = newTagsString
                    .split(',')
                    .map(tag => tag.trim())
                    .filter(tag => tag.length > 0);
                
                meeting.tags = newTags;
                await updateMeeting(meeting);
                
                // Atualizar visualiza√ß√£o
                const tagsContainer = document.getElementById('detail-tags');
                if (newTags.length > 0) {
                    tagsContainer.innerHTML = newTags.map(tag => `
                        <span style="background: #dbeafe; color: #1e40af; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.875rem; display: inline-block; margin-right: 0.5rem;">${tag}</span>
                    `).join('');
                } else {
                    tagsContainer.innerHTML = '<span class="text-sm text-gray">Nenhuma tag</span>';
                }
                
                alert('Tags atualizadas!');
                
                // Atualizar filtro de tags na home
                await renderTagFilter();
            }
        }
        
        // ==================== EVENT LISTENERS ====================
        document.getElementById('tag-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && e.target.value.trim()) {
                const tag = e.target.value.trim();
                if (!selectedTags.includes(tag)) {
                    selectedTags.push(tag);
                    renderSelectedTags();
                }
                e.target.value = '';
            }
        });
        
        // ==================== INIT ====================
        async function init() {
            await initDB();
            loadMeetings();
            
            if ('serviceWorker' in navigator) {
                try {
                    await navigator.serviceWorker.register('sw.js');
                } catch (e) {
                    console.log('Service worker n√£o dispon√≠vel');
                }
            }
        }
        
        init();
    </script>
</body>
</html>
